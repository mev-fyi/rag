00:00:00.330 - 00:00:34.002, Speaker A: Welcome back to the decentralized finance lecture. My name is Arthur and today we're going to discuss lending and borrowing in DeFi. Lending is a fundamental construct in traditional finance as well as in DeFi and it's a truly exciting topic. Come on and jump in. So why is lending so important? Who is participating in lending? What are the different entities? Why does it matter and what are the risks? So these are all the things that we're going to discuss in this lecture. And we're going to start with a very simple example. So here we have Bob.
00:00:34.002 - 00:01:36.730, Speaker A: Bob is really passionate about music. He loves it so much, he wants to perform and create music all day long. But he has an issue. He cannot afford this really cool turntable that he would like to have in order to create very nice music. So one possible solution is that he finds someone bart that is a bit more senior, maybe has accumulated a little bit more wealth, and he can ask him to provide him a loan. So he can ask him, can you please give me some cash such that I can purchase a turntable and I can create value through your investment, through your loan. So it's really this recurring process where an entity is required or needs upfront cash that it can't afford yet in order to produce ideally positive value for other people and then can generate a positive cash flow.
00:01:36.730 - 00:02:20.314, Speaker A: And this is fundamentally how the Economic Machine works. So I can really recommend you going here to Ray Dalio's video on YouTube that explains in a brief 30 minutes how the Economic Machine works. It's a beautiful video which basically lays out that we have an assumed productivity growth over time. We do have short term debt cycles and we do have longer term debt cycles. And all these three cycles, if you overpost them, then it's basically this kind of a structure over time. And on the Y axis here, you have to growth in terms of GDP. That shows you how the Economic Machine works.
00:02:20.314 - 00:03:13.900, Speaker A: Now you might notice like these bigger cycles here, they're often referred to as crashes of the financial economy. However, you can also find that there are some smaller crashes here because where overall the entire system is really cycle based, sometimes people need more money, sometimes they need less money. And this is on a very high level. The economic machine works. So lending and borrowing really is fundamental in this construct. And whenever there's a correction, like here, or even smaller corrections here, this is where the borrower. So for example, in our previous example, the younger person who lend money needs to pay money back to the lender for the debt that it accumulated early on.
00:03:13.900 - 00:04:08.758, Speaker A: So in essence, what you can remember is that lending allows you within a short time frame to instantaneously gain more capital. And this capital can be used in order to produce hopefully positive goods naturally, if it's being used for unproductive use, then you will pay a higher price back on later because you can't pay back your debt and you may go bankrupt, you get liquidated, et cetera. These are topics that we discuss in this lecture as well. Very well. So let's look at the onchain lending and borrowing system architecture. So you can see the following entities. Here we have a lender, we have a borrower, we have a liquidator, and we have a Price Oracle as well as a vault.
00:04:08.758 - 00:04:40.594, Speaker A: Let's start at the vault. So the vault here is a smart contract that manages financial assets among these different entities. And again, the blockchain is great at managing assets without a trusted intermediary. And that's exactly what's happening here. So the vault is taking on various tokens, whether fungible or non fungible doesn't really matter. And for the sake of this example here, we have a few stable coins representing US dollars. So what the lender typically does is he first needs to deposit a principal.
00:04:40.594 - 00:05:35.720, Speaker A: So this is the lender, he has a surplus of capital and he would like this capital to work for him or her. So the idea is that this capital generates some interests. For the capital to generate interests, there needs to be a borrower who in a first step collateralizes a certain security deposit such that the borrower can then take on a loan. For example, in some blockchain based protocols, you need to collateralize 150% of the value that you want to borrow afterwards. So Mechadao is a famous example. So once the borrower collateralized something, he can then borrow the assets and then he effectively, if he, for example, collateralized something, then he borrowed something. So the sum of his total assets are now bigger than before.
00:05:35.720 - 00:06:37.574, Speaker A: So the danger, however, is that he might get liquidated. So let's discuss how the liquidation process works. So this is the risk in lending and borrowing. So in essence, if this collateral here, if the value of this collateral drops below a certain value, if it's less than 150%, for instance, then price Oracles will update the onchain prices or the reported prices of the collateral assets. And if these drop below a certain threshold, which we'll discuss later, then liquidators are incentivized to issue a liquidation request to the vote. And the liquidators are incentivized to do so because they receive a percentage or they receive a discount, basically of this collateral that they can purchase, which is basically incentivizing them to participate in this particular protocol. So this is really just a high level overview.
00:06:37.574 - 00:08:02.466, Speaker A: We will go into more details in the following slides. But just to give you a hint of how these different actors are actually working together and playing along. So from a high level perspective, I would like you to think now what is the difference between onchain lending and borrowing and between real world lending and borrowing? So, if you go to your bank for instance, how is this process, how does this work, this lending and borrowing, what are the rules, et cetera. So think about it for a few seconds, pause the video maybe, and then we can resume. Okay? So I think some of the most interesting changes are that at the moment, at this point in time at least, we cannot collateralize real world assets, right? So if you do have a home or something that you want to collateralize, you currently don't have, or hopefully soon at least, but currently don't have the option to collateralize this as a security, right? So this is one of the drawbacks, I'd say that traditional finance is having an advantage that you cannot collateralize. The other difference is that if there's a debt default or the blockchain, this vault here, you cannot source, for example, your revenue from your income. So there's no legal framework that's attached.
00:08:02.466 - 00:09:00.338, Speaker A: So everything is really happening in this vault, in this framework. And it's not confined to, I mean, it's basically confined to this particular blockchain database, but it cannot capture real world events such as your salary or your income. Finally, there are several regulations out there that limit you in your ability to take on debt in general or leverage. And these are not in place in DeFi. In DeFi, it's currently totally unregulated how much you lend or borrow, which gives you obviously a lot of freedom. But you also must exercise caution to not basically become the victim of excessive losses. Just to give you like a few images of DeFi projects that allow you to perform lending and borrowing where you can become each lender or borrower.
00:09:00.338 - 00:09:25.506, Speaker A: So just to give you an example here, this is Aave, for instance. So you have a certain deposit APY as a lender here. This is curve that we discussed earlier. This is here, this is alpha mora, as we also discussed earlier. So whenever you take on debt, you exercise a multiplier. So you have a certain leverage. The leverage can be set.
00:09:25.506 - 00:10:01.466, Speaker A: There are various multiply parameters. So typically, as long as you're over collateralized, you don't go beyond two X in leverage. And if you're under collateralized, you can go beyond two X leverage. So some centralized exchanges at least offer up to 100 X, I believe, on chain. So far, as far as we have seen, you don't get more than seven X leverage. And I challenge you to create a D five protocol where you can do a 50 X leverage. I hope this gave you a very first good introduction of what lending and borrowing looks like on the blockchain.
00:10:01.466 - 00:10:46.726, Speaker A: In the following, we'll discuss and dive deeper into the very specificities of on chain lending. Welcome back. So while the previous segment already gave you a little bit of an introduction, we will dedicate now this segment to the terminology used in DeFi lending and borrowing. So let's start with the very first terminology that's quite important which is the collateral. Collateral is a security deposit. It's an asset that the borrower provides in order to secure its debt, right? So the more debt you take on, the more collateral you need to provide. Because the collateral is a security deposit that guarantees that you can pay back your debt.
00:10:46.726 - 00:11:40.678, Speaker A: You cannot take on too much debt, otherwise you would be indebted. So there needs to be some kind of a security deposit here. And based on this, there are two possible lending profiles, lending methods on chain at the moment, this is the first is the over collateralized setting. And second, it's the under collateralized setting. So in the over collateralized setting, it's where the borrower provides a collateral of which the value is higher than the granted loan, right? So this also implies that your leverage multiplier is inferior to two X. Under collateralized loans allow you to borrow more than you actually have. So the collateral value here can be inferior to the debt value that you take on.
00:11:40.678 - 00:13:03.334, Speaker A: And this also means that you can have leverage beyond two X in general. Now you might ask, well, great, I mean, on chain, I'm anonymous, right? I can just take on any kind of collateral and then just run away with the money because why would I need to pay it back? Nobody can catch me on chain, right? Well, the thing is, in the over collateralized lending systems here, you can freely use your money, right? Freely use the debt that you take on. So it's actually a token that you can redeposit. You can even redeposit it as a collateral in some systems, while in the on deck collateralized setting here, they are highly restricted. So you will not actually have access to the funds, right? So the smart contract will basically manage how you can deal with the money or what is being done with the money. So the under collateralized setting is much more restricted precisely because you want it to still remain secure in the sense that you shouldn't just leave with your debt. So the fourth term here that I would like to introduce is a liquidation that we already mentioned, the high level system figure.
00:13:03.334 - 00:13:57.998, Speaker A: So more formally, so if the value of the collateral goes beyond a certain threshold, for example, 150% times the value of the debt, then you might become liquidated. So anyone can open, can basically create a liquidation request, or anyone can liquidate a debt position. As mentioned earlier, you might get a percentage discount on the collateral value. So you get it as a lower value than the market value, which incentivizes you to perform a liquidation. But there may also be auctions instead of fixed spread liquidations. So next, terminology is a health factor. So what is a health factor? So the health factor is defined as the sum of all the collateral you have times a liquidation threshold.
00:13:57.998 - 00:14:51.450, Speaker A: So liquidation threshold is a value between zero and one and it basically discounts for the collateral. And so if you take all the sum of this collateral liquidation threshold, you divide it by the total value of your debt, you end up with the health factor. So the value of the collateral times the liquidation threshold times this discount is referred to as the borrowing capacity. So this is how much you can borrow. And as mentioned earlier here, the liquidation threshold is between 0.0 and one and provides us a secure margin. So it's not really secure in any technical sense, it's more like it's a buffer, right? It's really just a buffer of you think of how much will this value fluctuate and what is a safe way to avoid liquidation.
00:14:51.450 - 00:15:44.860, Speaker A: So when the health factor of a borrowing position declines below one, then this position becomes liquidatable. So this is the point in time where a particular liquidator can liquidate your position. Well, anyone can do this, but this is the point in time where entities are able to call the smart contract to liquidate your position. So let's go on on this health factor. Let's go on with a very concrete example. So we will have here a collateral. So we will take, for example, let's say we collateralize at the very beginning, we collateralize one ether, and the exchange rate between ether and die is 2000 at the start of this position.
00:15:44.860 - 00:16:40.540, Speaker A: So the exchange rate ETH die is 2000. So this means that the collateral value here, because we issue like one ether as collateral, the borrowing capacity that we can get is at maximum 1500 die. Okay? So in this particular example, and we say that liquidation threshold, we set the liquidation threshold to zero point 75. So given these numbers, we can calculate that the health factor in this particular instance is 1.2, okay? So that's at the very beginning of the borrowing positions. So now over time, so we open this position, right? So now over time, we can use our debt, right? This is capital that we have free access to. So we can do what we want with it, which is great.
00:16:40.540 - 00:17:32.426, Speaker A: We can continue to speculate, for example, on the ether value, but we do have additional die at our disposal that we actually can convert back to ether and continue the same gain if you want to. But let's assume we just stay with this 1250 die position and the ether price changes. So here the ether price goes down, right? So the exchange rate ether to die is now only 1600. So the value of the debt remains the same. This didn't change. I mean, we didn't pay back any debt, but now the value of our collateral here is quite smaller, and that's not great. And we can see that our borrowing capacity is now only 1200 die, which is inferior to our debt, which is 1250 die.
00:17:32.426 - 00:18:19.290, Speaker A: And this in turn also means that our health factor is now below one. And that's obviously not a great thing because suddenly we became liquidatable or this borrowing position became liquidatable. A few more terminology items that might really help you to grasp those protocols and systems. So you have a liquidation spread. As mentioned, this is a bonus or discount, right, that the liquidator can collect when liquidating collateral. So it's basically the value of the collateral to claim is equivalent to the value of the debts to repay times one plus this liquidation spread. So this is the value of the collateral that can be claimed.
00:18:19.290 - 00:19:10.586, Speaker A: The close factor is quite important in the liquidation setting as well. So that's the maximum proportion of the debt that is allowed to be repaid in a single fixed spread liquidation. So sometimes in some protocols the close factor is 50%. So this means you can at most pay back 50% of the debt in a single fixed spread liquidation. Well, 50% of a debt repayment is quite a lot. In many cases this will be an excessive liquidation and we've seen evidence on chain that liquidators are excessively liquidating the collateral from borrowers. So just to give you here some further information.
00:19:10.586 - 00:19:48.150, Speaker A: So the value of the debt to repay should always be inferior to the close factor times the value of the debt. But this close factor is yeah, it's mostly set as a constant, I think it's like 0.5 in RW, so 50%, which is quite significant and not in the interest of the borrowers in general. Very well. I hope this terminology will help you to speak the same language as we do, as well as to synchronize efficiently with your peers. Welcome back. We're going to dive now deep into overcollateralized borrowing.
00:19:48.150 - 00:20:55.018, Speaker A: In overcollaterized borrowing we have again two actors, right? So we have a vault here, which is the smart contract that governs the assets. And we do have a borrower that mints or creates basically debt. So in this particular example here, the borrower collateralizes, for example Ether and then borrowers die. So that's a very traditional way of creating a stable coin as in mechada. So in essence, we have here 150% of the value in Ether as collateral and we can then mint 100% of the value in die. So what's important is here that the value of Ether, which is the collateral, exceeds the value of die in absolute terms, right? So if you convert it to like a base currency and what's also important is that the borrower in this particular example can use the Dai freely at will. So he can push this around, he can actually convert it back to Ether, to any other currency, borrow more assets.
00:20:55.018 - 00:21:39.270, Speaker A: So that's really like a very non locked asset in a sense. The drawback, obviously is that the leverage that the borrower can take on here remains always below two point X. So this is probably not the model that a highly speculative trader or borrower would like to take on. To give you an example here we have the RV dashboard. This is a screenshot of a particular position. So we have someone with about ten k of collateral here. And this person also borrowed about 1500 US dollar worth of collateral.
00:21:39.270 - 00:22:23.980, Speaker A: So the health factor looks quite good, right? It's well beyond above one. So we had a 5.36 health factor and we've only used a part of the borrowing power so far. So this particular position can take on more depth if the person wants to. So if we look at here now the particular elements of this deposit so here we have a deposit of Dai, right? So this is Dai's deposit as the collateral. What's interesting in Aave is that the collateral itself is also lent out so the borrowers can earn interest. So you can actually activate this here with this button.
00:22:23.980 - 00:23:19.014, Speaker A: That's obviously a transaction that's being triggered then through the smart contract to activate that, this collateral is being used as something to be lent out. Because naturally there's also the risk of liquidation that comes along with this APY. What you can also see is that this person borrowed some uni tokens, like in total about 500 unitokens and the borrower needs to pay interest. So here's, the borrowing interest that the borrower needs to pay is quite high, right? At 113% in this particular example. So as I mentioned at the very beginning of this segment, this model is being heavily used by MakerDAO or was introduced by mechado mostly. So we're in step one. Borrower really provides a collateral, for example in ETH.
00:23:19.014 - 00:24:10.570, Speaker A: But it can be various different currencies as well nowadays. So you have a multi collateral Dai nowadays. So once you provide some collateral in this step, then the smart contract will mint Dai or so the borrower can draw Dai from the particular mechado smart contract. So this is the debt that the borrower can freely operate with. And in order to close this CDP or debt position, this collateralized debt position, the borrower can then repay the debt which is Dai, right? So if Dai is repaid to the contract, then the contract will unlock the ether such that the borrower can return the borrowed funds. Voila. These were the most important basics for over collateralized borrowing.
00:24:10.570 - 00:24:53.420, Speaker A: Borrowing where you cannot surpass two X leverage. So if you're interested in high leverage, check out under collateralized lending. Welcome back. We're going to dive now into under collateralized lending lending that enables you to leverage beyond two X similar to over collateralized lending. Here again we have a borrower, right? So the borrower, for instance, can collateralize ether and borrow die. And again, we have here a vault where the borrower deposits his assets. However, the difference now is that the value of Dai, which is the debt, can exceed the value of the ether which is the collateral in this particular case.
00:24:53.420 - 00:25:48.780, Speaker A: And what's quite critical in under collateralized borrowing is that the borrowed Dai and the collateralized ETH, they are restricted to be used with predesigned smart contracts. So you can't code up your own contract and send your debt towards this contract. You must use predesigned designed contracts from the lending and borrowing platform itself. So these are typically farming contracts. So if you want to generate yields based on your debt, then that's obviously something that you may want to consider, but otherwise it's probably not going to help you if you want to do any arbitrary action with your debt. So which seem really important here. The vault remains in control of all assets at any point in time during the lifecycle of the debt position.
00:25:48.780 - 00:26:25.830, Speaker A: One example screenshot is the following here. This is Alpha Homora or the dashboard of Alpha Homora. We have here collateral value of a particular peer of $1,900. Then we have a small amount of debt which are $350, and we are receiving some tokens as a reward. So that's a particular APY based on the tokens. And you can also see here basically the position that's being opened. So that's a position in the Uniswap ETH Dai pool.
00:26:25.830 - 00:27:19.660, Speaker A: Okay, you may add additional elements or you may close the position if you'd like to. In alphomora. You can also see all open positions, so you can inspect basically on their webpage how these positions look like. What's the debt ratio? I think this is something that you might be interested to further look into. You can explore the collateral credit, borrow credit, and the overall collateral value. Note that there are some pools that are stablecoins, like this one here, and other pools that are more speculative coins that are less, that are not stable or not supposed to be stable. So we crawled Alpha Omora and actually from its inception so Alpha Mora started in October 2020.
00:27:19.660 - 00:28:18.938, Speaker A: We crawled the smart contract data until August 2021 and we found that there are about 3800 borrowers, of which we found 10,430 leveraged positions that were closed at the end of our measurements. So we basically were searching for all the open borrowing positions in an effort to be able to calculate their final APY, so their final return and whether it was worth it or not. So we got some interesting data. So for example, we found that the average leverage multipliers are about two point x and three point X on the respective iPhone or versions. So there's a version one and a version two. The main difference is that the version two allows for more assets beyond ether to be used. We also find rather intriguingly that stablecoin leverage multipliers on average are quite higher.
00:28:18.938 - 00:29:29.090, Speaker A: So the average stablecoin multiplier is 5.4 almost, which makes sense because stablecoins are by nature less volatile, so it's less risky to take on a higher leverage and the risk of being liquidated is naturally not that big then. So how are borrowers choosing leverage multipliers? So we have here plotted our results based on whether these are stablecoins, partial stablecoins or non stable coins. So stablecoins is any pair of assets that are stable. Partial stablecoins is where you have like one stable, but another non stable coin. And non stable coins are just tokens that are non stable. And you can again see the distribution here of the leverage multiplier for stable coins being significantly higher than the leverage multipliers for partial or non stable coins, which are more or less the same, right? So they have more or less the same users basically more or less choose the same leverage multipliers as soon as you have a non stable coin in your basket.
00:29:29.090 - 00:30:14.642, Speaker A: So if we look at the various platforms in this second plot, we differentiate between the different platforms. We show curve, balances SushiSwap and uniswap and we can find here that for Curve. So that's the red one, right? Most of the leverage multipliers are rather high, which makes sense. Curve supports the most stablecoin pools, but also Uniswap does support a few stablecoin pools. So it's quite interesting to see here a few high leverage positions on uniswap. And otherwise SushiSwap is taking quite a bunch of the positions that are there. So this data is based on leverage multipliers in alpha moro, version two.
00:30:14.642 - 00:31:09.074, Speaker A: So about 2500 positions that we investigated. Now, you might ask, what's the API and the leverage? I mean, why wouldn't I take always the highest leverage possible, right? So on the x axis, we plot the initial leverage that we found those alpha mora positions to take up to. So this is the initial position that when at a time that you open the leverage. And then we calculated, after closure of the position, we calculated the API, the borrower API. And you can see here, it's not always shiny rows positive. We have quite a few cases where the APY is actually negative and can even be significantly negative. So the size of the dots here actually represents the size, the relative size of the position.
00:31:09.074 - 00:32:09.106, Speaker A: So the bigger it is, the bigger the position relative to the others. And we differentiate it here according to the duration of the position. So the red dots are all the positions that are actually shorter than a day. And you can see by adding a regression line here that the shorter the duration and the higher the leverage, the worse the API becomes, right? So in expectation here, for example, for seven x leverage, the borrow position is really quite negative regarding the APY, luckily, I mean, these positions are rather short term lift. So it might also be that the borrower actually just exited the position quickly in order to avoid further negative exposure. But it's interesting, like longer term positions remain rather positive here. These are close to positive.
00:32:09.106 - 00:33:21.062, Speaker A: So there's a big variety at least. And you can see once we look here at higher leverage positions, we have certainly more data points on the negative side than on the positive side, which appears empty, whereas if we look at the leverage multiplier of like about two. So in this spectrum here, two, two, maybe three, then we can see more or less an even distribution between positive and negative ones. Yeah. So I leave the further inspection of the data or interpretation of the data up to you. And yeah, feel free to let us know in the comments or in the chat if you have any further thoughts based on these visualizations. So you might ask, so why shouldn't we choose like a leverage, why shouldn't we always choose the maximum leverage? And why does leverage not always amplify the APY in practice? So in practice, the leverage multiplier actually has an impact on a variety of different risks or events that we can find naturally.
00:33:21.062 - 00:34:28.770, Speaker A: If you just look at the revenue, a leverage multiplier should increase your revenue. However, because you're borrowing more funds, right, you want to leverage more, so you need to borrow more. The borrowing interests also increase and they might be quite excessive, so depending on the market state, they can be significant. Also, your liquidation risk increases as you increase your leverage multiplier, which is a danger you don't want to be exposed to because once you get liquidated, your collateral is sold at a discount and obviously you incur a loss. So just like the automated market makers, also in alpha mora or under collateralized lending platforms, you do experience an impermanent loss. And this impermanent loss can be sometimes positive, sometimes negative, especially because of the type of margin trading that's possible on these platforms in which we don't have much time to go into further now. But I will really encourage you to explore these particular risks here and to further understand them.
00:34:28.770 - 00:35:00.220, Speaker A: Feel free to also ask questions at any point in time. So thank you very much for your attention in this exciting leverage or under collateralized lending platform. I would strongly recommend to try them out yourself. But be careful, you might incur a total loss of funds, especially if you choose excessive leverage multipliers. So maybe a little bit. A smaller leverage multiplier is the safer bet, but it's up to you. Welcome back.
00:35:00.220 - 00:36:01.774, Speaker A: Being liquidated is probably the biggest risk in borrowing lending because you will be losing quite some value of your collateral as it's being paid out to liquidators at a discount. So this is something you really want to understand and avoid if possible. So let's dive into it. So what can possibly go wrong, right, if you're lending or borrowing assets? Well, as we mentioned and indicated earlier, the collateral value can decline such that the debt, it would not be rational to pay back the debt and that's really a debt default. It's not great for the lender in general. So therefore there's this security mechanism called a liquidation that should sell the collateral from the borrower to limit the losses of the lender. But that's, again the zero sum game.
00:36:01.774 - 00:36:26.390, Speaker A: That's not great. For the borrower, right? Because there's a liquidation spread. So there's a bonus or discount for a liquidator. And there are various means of how something can be liquidated. There's, for example, a fixed spread liquidation mechanism that we will go into a little bit. Or there's a variable on auction based liquidation mechanism. So before we go into DeFi, let's look into liquidation and traditional finance.
00:36:26.390 - 00:37:19.918, Speaker A: Well, it's quite a complicated process, right? So there might be a court order for liquidation. Or maybe, for example, the board of a company chooses, passes a resolution for a voluntary liquidation, or creditors pass a resolution for liquidating at a watershed meeting. So then the liquidator notifies the company's office. Then there is an advertisement of the liquidation in some public forum that people can look into. Then creditors are basically having a meeting to confirm the liquidator. There's an administration of liquidation which may include the closure of business, the realization of assets, selling of assets, calling for claims, paying for dividends. So the next step is there's an ongoing report to creditors in companies offices.
00:37:19.918 - 00:38:02.642, Speaker A: And this process really takes like ages, takes many months, can take years even. And then there's a completion of administration. So there's a final report that will be created, there will be a notification of the company's offices, and then finally the company will be removed from the commercial register because it's liquidated. So over in all, this is the liquidation process for corporation, very high level, obviously, with probably many nuances and DeFi. It's much more simple. Let's look, for example at the fixed spread liquidation mechanism. So in a fixed spread liquidation, we have here again the vault.
00:38:02.642 - 00:38:25.150, Speaker A: We have a liquidator who's interacting with this vault. So the liquidator repays the debt. In this particular example, he repays die and acquires the collateral ether at the discount. So he's repairing this borrowing position. And the discount depends on the particular platform you're looking at. We seen anything between five to 15%. For example, in Ave.
00:38:25.150 - 00:39:04.860, Speaker A: What's important is that this liquidation is being executed in an atomic transaction. This is in one transaction, the vault is receiving the debt and paying out the collateral. So that's an atomic transaction. The liquidator doesn't need to trust the vault. This is guaranteed to be executed if the liquidator is actually issuing this transaction. So let's look into a more mathematical example here. You may remember our previous example where we calculated the health factor of a position.
00:39:04.860 - 00:39:49.162, Speaker A: So we continue actually on this prior example where we have a bad health factor, which is below one. So we have a zero point 96 health factor, mostly because the borrowing capacity is 1200 die. And actually our depth is beyond that, it's 1250 die. So this means currently, this position, this depth position, right, this one here is liquidatable, which means that the entire collateral, this here is actually opened up for liquidation, meaning it's opened up for being purchased by some entity. At a discount. So if we have a close factor of 0.5 and a liquidation spread of 0.1,
00:39:49.162 - 00:40:57.790, Speaker A: then we can actually calculate how much a liquidator can get from this particular position, right? So given that the close factor is 0.5, the maximum that the liquidator can pay back from the debt is 50%, and that's exactly what the liquidator is doing here, right? He's paying back 625 die from 1250. So 625 die are remaining debt in this particular position. So the good news is, now the health factor grows beyond one, right? We have a health factor of 1.95 here, and that's because the liquidator got a part of the collateral, but he didn't get everything because he also did not pay back the entirety of the debt. So, however, the liquidator here got zero point 43 ether, which corresponds to this amount of die. And this is the entire position, how it stays.
00:40:57.790 - 00:42:02.146, Speaker A: So what we see here is that this particular, I mean, such liquidation is reducing the total locked funds in a borrowing and lending platform, right, because it's effectively taking money out of a borrowing platform. And this can be quite significant, with 50% of the debt available to be repaid. And naturally, the borrower here in this particular example will incur loss because there's a discount, there's a liquidation spread of 10% that the liquidator can benefit from. Another type of liquidation mechanism is a liquidation auction. So if you have here a timeline and here a few blockchain blocks, this actually goes over, this is a non atomic liquidation. So this requires multiple blockchain transactions. So let's imagine the auction starts at a particular block height here.
00:42:02.146 - 00:42:54.260, Speaker A: Then we have two liquidators that are competing, so they can issue basically a few bits in every block. And then at some point, the auction terminates. And then the smart contract, given the list of incoming bids, will determine who is the winner of this particular auction. The main two auctions that exist in DeFi are the English auction, so where the bidders outbid each other increasingly, as well as the Dutch auction. So where the auction begins with a high asking price and then over time falls down to lower prices until the auction terminates. So, initially, Mechadao, we're going to continue using mechadao as an example in our slides here. So initial mechadao followed the Tent and Dent auction from its inception until April 2021.
00:42:54.260 - 00:44:25.502, Speaker A: So the Tent and Dent English auction is interesting because once we initiate here the auction, we have two phases, intent and an end phase. And in the Tent phase, you can see here, so D represents the depth and C represents the collateral. So if I want to make a bit, then I have to create basically a bit with di plus one, where di plus one has to be bigger than di. So it means that the amount of debt that I want to repay is bigger, right? So I have to basically purchase an increasing amount of debt for the entire collateral. Okay? So I'm increasing the debt that I repay based basically on the collateral that I can get there. And once I reach the equilibrium, let's say, right, once, once I get everything back, then we can still continue with the debt phase, and I have to pay back the entirety of the debt, but I only get a smaller amount of the collateral in return, right? So CI plus one here has to be smaller than CI, meaning in this particular case, I have to pay back the entire debt, but I only get this fraction of the collateral in return. And finally here, once we are finished, the auction terminates.
00:44:25.502 - 00:45:28.378, Speaker A: So there's a certain time constraint on how long an auction can last or should last with hard deadlines, actually in the case of Mechadao, so this model was not great. We will look into a case study later on, but make it out. Changed the auction model from April 2021 to present, we now have an instant settlement. So, instant settlement, Dutch auction. So unlike English auctions, which are operated over multiple blockchain transactions, the Dutch auction now is settled instantly in one atomic transaction. We can do a flash lending of collateral, so there's no upfront die that's required, and there's a flash loan which can be used specifically for mechanical auctions, which is great, because this simplifies the liquidation mechanism. There's also a price as a function of time, so the collateral price decreases over time, and nobody can get or receive the collateral for free by accident, as happened in Mecado.
00:45:28.378 - 00:46:26.790, Speaker A: And we will look into in a later slide to give you further insights into liquidation statistics and why these are actually quite important for DeFi. We have crawled the on chain data for five different platforms. So you can see here, these are the DeFi platforms that we have looked at in a time frame from 2019 here until 2021, April 2021. And you can see on the Y axis here the accumulative US dollar amount. And you can see that the must liquidations, for instance, happened on compound. So, compound was the platform that had the biggest amount, US dollar amount of liquidation. So in total, we identified over 28,000 successful liquidations and 800 million USD of collateral that was sold through liquidations.
00:46:26.790 - 00:47:19.126, Speaker A: If we look at continuing statistics, we can see based on the amount of liquidations, we can extract their profit. So over the same time frame, over the same platforms we found, this is like there's a 63.6 million US dollar in profit from liquidations alone. We can see some outliers. So in particular, there was an outlier here in March 2020, there was a liquidation bot failure. So the default maker, Dow liquidation bot was not functional during a significant price crash of the ether cryptocurrency. And this bot failure prompted liquidators to just bids like very small or almost no amount in the liquidation events.
00:47:19.126 - 00:48:02.402, Speaker A: And this basically caused a spike here. So we have cut the axis. So bear in mind, this is actually quite a significant event back there. So almost above actually 13 million US dollar of profit for liquidators just that particular day. And overall liquidators have shown to actually receive quite a significant profit on compound RV has been not bad, also in April for liquidators. So liquidations are very competitive. So here that's why again, over the same time frame we plot the gas price in Gigaway.
00:48:02.402 - 00:48:53.990, Speaker A: So if you remember the smart contract lecture, gas is the unit to pay transaction fees. So the more you pay, the earlier you might get included in the blockchain. And we can see here that we have basically evolution or growth of the average gas price as well as of the liquidation price. So you can see here we plot this gray, almost black line as the average gas price. And you can see that consistently the liquidations are actually above this rather significantly. That's a lock scale, right? So we have a y axis which is a lock scale. So these amounts are quite significant, indicating severe competition among liquidators.
00:48:53.990 - 00:49:47.720, Speaker A: Finally, so we have further liquidation statistics. So liquidation, especially the liquidation sensitivity that we investigated among these different lending platforms. So you can see, so these plots are basically indicating the same data. I just would like to explain it here on one. So on the x axis we have the price decline in percentage, right? So if you can think of a price decline of 80% of the collateral, then you will see how much collateral becomes liquidatable. So there's some thresholds you can see here that are quite significant and suddenly a lot of collateral gets liquidatable. And you can basically see a few thresholds here that are quite significant depending on the platform and the cryptocurrency that you're looking at.
00:49:47.720 - 00:50:34.230, Speaker A: So if you have any positions in these markets, I would recommend you to basically plot these types of risks assessments on an ongoing real time basis so that you can make informed decisions yourself. I hope these statistics and insights about the various liquidation mechanisms were very helpful, especially if you do plan or already have borrowing or lending positions opened. This is a very exciting field. I think there's still much room for novelty. So if you want to propose your own liquidation mechanism or your own liquidation bot, feel free to try it out. Welcome back. You're slowly but surely becoming a liquidation expert.
00:50:34.230 - 00:51:23.618, Speaker A: We're looking into further case studies and insights in the following segment. In March 2020, there was a significant drop in cryptocurrency asset prices and Mechadao was heavily affected. It was called the Black Thursday for Mechadao, where $8.3 million was liquidated for zero die. So this was a single liquidation event where Mechadao liquidator basically created liquidation request for zero die. So he don't wanted to repay the debt which is denominated in Die, but he wanted to get the entire collateral back. And this happened due to the opportunity to win liquidation auctions with zero bits.
00:51:23.618 - 00:52:16.274, Speaker A: So 36% of all liquidations on mechadao that day were affected. So the greatest vault, as we can see here, lost like about 35,000 Ether. And the most successful liquidator had a profit of about 30,000 Ether. Quite significant and unfortunately a big loss to the protocol at that day. Luckily, since then, MakerDAO Innovated and changed a liquidation mechanism since April 2021. So what was the actual problem? Well, the problem was that first the market collapsed, right? So if the value of the collateral is declining, then there are liquidation opportunities arising. At the same time, if there's a lot of frenzy on the market, the gas price increases.
00:52:16.274 - 00:53:15.660, Speaker A: And we've seen this over and over again on the Ethereum chain and other blockchains as well. What then happens is that megadaobots should actually issue bidding transactions in the auctions. But because the gas price was so high, the megadaobots were not programmed, they were not parameterized appropriately to actually increase the gas price significantly to mine the liquidation transactions. And therefore the issued transactions that should have created a bit in these auctions were not mined. And if they're not mined well, then they don't hit the blockchain and they don't exist, as if that didn't happen. So this is certainly something that you want to avoid. And I think what MakerDAO really did beautifully now is to change their liquidation mechanism into a model where it's not possible to gain an auction with a zero bit.
00:53:15.660 - 00:54:01.050, Speaker A: You really have to basically the price goes down and not up. That's, I guess, the main insight. So what further liquidation insights can we find? So, first of all, the health factor is quite critical as we've seen, right? If you have a health factor of a position below one, then you are liquidatable. Unfortunately, however, the fixed spread liquidation does not necessarily increase the health factor. We had this example where we are decreasing the we're paying back the debt and we're also getting in return collateral. So the reduction in collateral again is actually bad for the health factor. So the fixed spread liquidation is not always helpful.
00:54:01.050 - 00:54:52.860, Speaker A: What we've also seen is there's quite an amount of over liquidation. So liquidators sell excessive amounts of collateral of the borrowed collateral because the close factor are for example, 50%, meaning you can pay back 50% of the debt, but maybe just 10% of the debt would suffice to render the position healthier again. So there's an excessive losses that the borrowers have to pay. And finally, we have not seen many liquidators performing so called optimal liquidation strategies. So liquidating up to the close factor is not necessarily the best strategy. Instead, it appears that two successive liquidations might offer a higher profit and we will go into a specific number example later. But let me show you the algorithm for this.
00:54:52.860 - 00:56:15.330, Speaker A: So basically the idea is if you have a position that's liquidatable, you don't directly push it to the close factor, but because you have a close factor of up to 50%, you want to use this close factor several times, right? So, in the best case, you liquidate, for example, 0.49% of the entire debt. So you repay four nine, 9% of the entire debt, and then you have a second liquidation where you push it beyond, you actually go to 0.5%. So you repay 50% of the debt. Through such case, you can pay back more debt than 50% and benefit from this increased or the bonus that the liquidator gets. So now obviously it depends, the exact numbers depend a bit on the value, on the health factor, on the collateral, on the debt value, but you can feel free to apply the algorithm here that you see. So the intuition is really in the first liquidation you don't bring the health factor beyond one, and in second liquidation you bring it above one, but in a way that you maximize your potential revenue as liquidator.
00:56:15.330 - 00:57:44.770, Speaker A: Furthermore. So if you're a borrower or if you're a lender, you want to know which of the liquidation mechanisms are the best for you, right? So, especially if you're a borrower and you see that the platform like dYdX does not have a close factor, so it means you can actually liquidate 100%, so there's no limit. Then you can see that the profit to volume ratio here over time, so Dy, DX here is like almost always the highest, right? So this is the profit to volume ratio for the liquidators. So if this profit to volume ratio is higher, then this means this is better for liquidators but worse for borrowers. Data basically suggests that auction liquidations might be more borrower friendly, right? Because mechadao here is the orange line, which is a bit lower. We interestingly see some difference between RV version one and vision two, but this is basically one possible normalized metric to compare which liquidation mechanisms are nicer or more profitable or more safe, for which actors of a boring lending market. Next is the dangers of divleriging spirals.
00:57:44.770 - 00:58:52.630, Speaker A: So we've seen this on chain several times. So if you have a liquidation event, then the liquidators sometimes atomically already liquidate, right? So they create a liquidation because the collateral price declines, then the liquidators are worried, so they might actually sell their collateral that they purchased, which will then trigger additional liquidations. And this is basically a possibly ongoing cycle, and it's called deleveraging spiral, right? So, upon liquidation here, the liquidators will sell the collateral, which then triggers the price decline, which then triggers again further liquidations. So it might be a good question whether liquidation is a good solution to secure lending pools. There might be other solutions. So I'll invite you to propose any ideas that you have. Let's dive into a particular on chain study.
00:58:52.630 - 00:59:35.958, Speaker A: So, how to apply an optimal fixed spread liquidation. So, I've already shown you the algorithm, and you may now look into this very analytical example. So we take as an example a liquidation that happened on November 26, 2020. On compound, the liquidation threshold is zero point 75. And we have here the particular block state that we give you, and there's also price update afterwards. And after the price update, we can see that the position here becomes liquidatable. So feel free also to stop the slides and look into the data itself in more detail.
00:59:35.958 - 01:00:31.350, Speaker A: But we have shown you here basically the entire amount. So the value of the debt, the value of the collateral, and which tokens were participating in this particular example. So what we have found is that the original liquidation, so the liquidators on chain choose to repay 46 million US dollar. He then received 49 million. So he realized a profit of about 3.7 million die, which in itself is not a bad profit, right? But we are speaking here about making things optimally, so it's clearly not the optimal strategy. So the liquidators in this particular example has actually not liquidated the maximum close factor that he could have.
01:00:31.350 - 01:01:30.518, Speaker A: So he could have gotten 3.73 million if he would have pushed the liquidation up to the maximum liquidation close factor threshold. And we show, however, that if we perform two liquidations, so we have a first liquidation, liquidation number one, which does not bring the position back to a healthy state, and then we subsequently apply a second liquidation. If we do those two together, we could have achieved a profit of 3.74 3 million die, instead of the original 3.69 million die. So these amounts are not negligible, these are significant amounts that we could have gotten in addition to the original liquidation profit.
01:01:30.518 - 01:02:36.880, Speaker A: So we believe that liquidators will become more professional as time goes on, as we have seen in DeFi in general. So this will become a more competitive game and liquidators will gain more money from borrowers. So what ideas do you have to avoid liquidations? So feel free to pause the video, think about this for a bit, and I think we need solutions for other designs to change the way that the liquidation mechanisms are working. But I'll leave it up to you, and feel free also to suggest in the chat or in the forums and we can discuss further. Thank you very much for your attention. I hope these additional insights about liquidations who gains, who loses, are helpful to you. Feel free to go on chain and check out liquidation events yourself nowhere, as usual, right? In DeFi everything is transparent, so you can verify the techniques that other people apply and learn yourself.
01:02:36.880 - 01:03:10.486, Speaker A: Welcome back. In this segment we will discussing flash loans, a truly novel construct that DeFi brought us, which does not exist in traditional finance. So it's really exciting. Let's dive into it hypothetically. What if Bart could grant a loan to Bob without the risks of Bob defaulting on the debt. Sounds too good to be true, right? No, it does not. It is called a flash loan.
01:03:10.486 - 01:04:01.338, Speaker A: So a flash loan is a loan that you can take from a vault. So this is your lending pool. It's a smart contract based lending pool. So you can take the flash loan, you can do something with it in your smart contract. So go wild with the loan if and only if by the end of your transaction you repay the loan plus the accrued interest or the requested interest basically, which depend on the size of your loan. The interest here in this particular example do not depend on the time. There is no notion of time in a flash loan because the loan is only granted within a single atomic transaction because the taking of the loan and the repayment of the loan has to happen in the same transaction and therefore there's no notion of time.
01:04:01.338 - 01:05:01.446, Speaker A: So the interests here are only a function of the amount of the loan. So for example, like various platforms like Uniswap or Ave offer flash loans at a 0.3% fee, which is quite significant if you extrapolate it for an APY if you're going on every day doing flash loans. But that's the current state of the market. So if we look at it a bit more, slightly more technically so we have here smart contract pool, right? We do have Alice again who is adding liquidity to this pool. So she's a liquidity provider and we have somebody else like Bob here who would like to lend the asset X from Alice within a single atomic transaction and she will repay it by the end of that transaction and pay the fee to Alice. So it's really like a special form of lending.
01:05:01.446 - 01:05:58.490, Speaker A: You shouldn't be thinking of it like as a long term lending or any time component there. It's really just a very instantaneous lending process. So the beauty is that if the repayment and the fees here, if they're not paid, then this loan will not happen, right? So then it's as if this loan was never granted at all. So this is really like the gist of the DeFi flash loans. So either you pay it back or you don't pay it back. So if the repayment is not performed, I repeat, then the transaction will fail, right? You have these three steps, right? You have take loan, do something with the loan and pay it back. If step number three does not happen and this is one transaction, right, then the entire transaction will fail.
01:05:58.490 - 01:06:46.378, Speaker A: So the state changes of step two and one will actually never materialize on chain. It's as if the loan was never given. So it's as if the entire transaction did not happen or at least the steps in it did not happen. So what are the common flash loan pools that we can look into and that we can use nowadays? Uniswap has two versions version two and three with an accumulated 7 billion US dollar that you can lend. So everybody can do this, you can do it today and you would need to pay a 0.3% fee. Auvi has a significant pool of 10 billion US dollar and dYdX has a much smaller pool, however also a much smaller fee.
01:06:46.378 - 01:07:25.850, Speaker A: So it's a constant fee of one way per flash loan, which is quite cheap. And so keep in mind that fees are important, right? Especially at those amounts that we're here discussing. 0.3% is not little money. So we've looked at the on chain data of various pools and we've looked into the accumulative flesh loan amounts. So keep in mind that this is data that's a little bit outdated and so it went until October 2020. But it has a logarithmic scale on the Y axis, so keep that in mind.
01:07:25.850 - 01:08:52.994, Speaker A: And you can see that it seems that Die, at least until then, was the most popular coin. So this is one of the most popular coins that got lent out in flash loans. So based on this data, you might ask yourself so what is actually the use case of a flash loan, right? So where can I take advantage of a flash loan or what can I do with a flash loan? So in most cases, flash loan is rather helpful in DeFi attacks. So it's not the cause of a DeFi attack, but it's a tool that an adversary can use. So in particular, if you're using a price Oracle, or if a DeFi platform is using a price Oracle that can be manipulated with significant transactions traits, then flash loan is like a perfect tool to manipulate this price Oracle as well as to perform potential pump and dump transactions. So that's why I would always recommend to use more advanced price or records like either external ones or time weighted average prices as reported, and now used by Uniswap for instance, which are quite more resilient to DeFi attacks based on flash loans, which is great. A flash loan.
01:08:52.994 - 01:09:44.834, Speaker A: The probably biggest and most beautiful use case I've encountered so far for flash loans is Arbitrage. We have already looked into this earlier in the next lecture. We will revisit this in the next slide. There's also the option of performing wash trading. Remember, if we have two markets with asset X and Y, then this is for Arbitrage. But if you have wash trading, you might want to purchase here asset X or sell Asset X, you get asset Y and then with the asset Y you go again here, you sell asset Y for Asset X, right? So this is a cyclic trade on this particular market here. So this could be a form of wash trading.
01:09:44.834 - 01:11:17.542, Speaker A: I mean, it is a legitimate trade, but your intent here is probably not to make a profit, but rather to just artificially inflate the trading volume. And you can obviously use flash loans to perform these types of transactions as you can also do it to communicate or to exchange assets on any other markets with these assets. And the beautiful thing is really keep in mind, right, if you take a flash loan so let's see that this is the flash loan provider, so we can go and do anything, right? You can buy assets here, then hop here, then go there and hop back to the flash loan pool. The only important thing is that you pay back your flash loan here by the end of the transaction, plus the accrued interest. Another feature that I have not found much use yet, but there might be some use is Flash minting. So if you do have a token, like an ERC 20 token, you can inject a functionality that this token is mintable, but flash mintable, meaning you can mint as many tokens as you'd like, but you would need to destroy these tokens by the end of your transaction. So that's not something that you could use in governance voting, because governance voting typically is over a time frame, for instance, right? But that's basically a potential use case.
01:11:17.542 - 01:12:14.070, Speaker A: But I haven't seen anything. If you know of any cool use cases of Flash minting, please comment in the chat or in a forum. And finally, collateral swapping is actually use case of flash loans that's actively being used, where a borrower can replace its collateral with a flash loan. We will show a particular example at the end of this segment so to iterate on flesh loan arbitrage. So remember, we have here two assets, two markets, right? A curve y pool and curve s USD pool and we do have a flash loan provider. The flash loan provider only requires a payment of plus one way as a fee, which is rather cheap. So what we can do is we can request a flash tone of 2.80
01:12:14.070 - 01:13:26.206, Speaker A: 48 million USDC. We then exchange it at the Curve Y pool for a specific amount of die. With this die, we go to the Curve SUSD pool and we exchange it back to USDC and we end up with a profit of about 16,000 USDC. Now, at the very end, we have to pay back the initial flash loan that we requested plus the one way. And this is where if you have to pay a 0.3% fee, depending on the size of the loan, the profit might be really small, right? So this is where especially for arbitrage amounts like below 100 million, I think the DBA DX pool is probably the best flesh loan provider for you because you're just paying a much smaller fee than in bigger providers such as Aave and others. So keep in mind that there's no official documentation for the dYdX contract on how to use flash loans there.
01:13:26.206 - 01:14:08.698, Speaker A: It's not as simple as Navi, but it's likely worth it, especially if you're being a professional arbitrager. Okay? So another use case of flash loan. Is flash loan based liquidation. So when a liquidator does not have access to the cryptocurrency that he needs to repay debt, he can use a flash loan. This obviously only works when the liquidation mechanism completes in a single transaction. So otherwise this would not operate. So given a liquidatable borrowing position with a depth of 2000 die and collateralized by two E right here, in the following, we can do this.
01:14:08.698 - 01:15:25.038, Speaker A: So we can take 1000 die from a flash loan, right? And we provide 1000 die. So from the 2000, right? We repay 1000 die and we can then claim 1.5 ETH, just a numerical example here. Given this 1.5 E, what we can do is we can swap this at uniswap, for instance, or some other decentralized exchange, and we can all do this in a single atomic transaction, right? So we go to the ETH die market on some decks and we then receive 1500 die from the swap. We proceed to pay back the flash loan plus potential interest, let's say 1000 die here, and we end up with 500 die in profit for this particular liquidation. So that's naturally making the liquidation mechanisms much more flexible and quick, because the cost for the onchain liquidators are rather minimal, right? They only have to be aware that this is happening, that they can issue this particular transaction, they need to manage the gas price, et cetera.
01:15:25.038 - 01:16:31.770, Speaker A: And this is really making Flesh loans or flash loans useful and liquidations more stable compared to a model where the liquidator needs to operate cash reserve to perform a liquidation. The last example that we're looking into in this segment is the collateral swapping. So let's assume that at the beginning we have a debt position here, where we have a depth of 1000 die and we have a collateral of one E that we are currently having in this position. Now, imagine that you want to keep the depth of 1000 die, but you no longer want to hold the ether in this particular depth position. So you want to swap it, you want to swap it out for something else, you want to swap it for USDC. Then the following steps can be taken in order to swap out the debt position. So, step number one, we take a flash loan of 1000 die.
01:16:31.770 - 01:17:42.670, Speaker A: We repay the die, right? So we repay the debt basically in the flash loan. This allows us to regain access to the ether that we collateralized earlier. And now we can swap the ether, for example, to 2000 die, right? If this is the equivalent value at the time of the flashnel, then we simply need to collateralize the 2000 USDC if the lending market allows such collateral and then we can borrow again the 1000 die. So this is basically the entire process of collateral swap. So we end up with a more stable coin debt position. So the risk of being liquidated here is much smaller compared to the volatility of the ether currency in this particular example. Now, keep in mind that flash loans overall are quite expensive in terms of gas prices, so you would not want to do this every day, but at times of high volatility, maybe it can rescue your debt positions.
01:17:42.670 - 01:17:56.930, Speaker A: Thank you so much for your attention. Flash loans are a truly amazing construct, and if you have any idea of what use cases we can perform with flash loans, please let us know. We're eager to hear about your ideas.
