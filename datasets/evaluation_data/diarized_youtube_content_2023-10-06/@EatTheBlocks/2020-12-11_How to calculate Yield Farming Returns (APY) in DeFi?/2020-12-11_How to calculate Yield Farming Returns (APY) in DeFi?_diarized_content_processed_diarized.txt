00:00:00.410 - 00:00:47.510, Speaker A: If you've been in DeFi for a while, you probably saw this crazy yield farming return, like 100%, 200% or even more. Is it true? Well, yes and no. And in order to understand this, you need to dig into the concept of APY, or annual percentage yield. So in this video, I will explain in detail what is API and how it's calculated in d five project. And I will take the specific example of compound, which is a very popular defi project where you can lend and borrow token in a decentralized way. And we will also create a script in node js to get the APY of the main markets on compound. And if you don't know me, I'm Julian and on my channel eat the blocks, I teach blockchain development.
00:00:47.510 - 00:01:30.914, Speaker A: I'm actually working on a new course on DeFi programming. If you want to be notified when it comes out, make sure to register with the link down below. So in order to calculate an APY, you need to first understand the difference between simple and compound interest. So let's see how this works. So let's say that you have $100 and you lend it to someone at an interest rate of 10% annually. By the way, that would be a really nice rate. So you lend the $100 in January 2019, and one year later in January 2020, hopefully you get your money back, plus your interest and total, you get $110.
00:01:30.914 - 00:02:06.942, Speaker A: And you can see the formula that I've used to come up with this figure. So now let's compare this with a loan with a 5% interest rate, which is semiannual. So 5% semiannual, is it equivalent to 10% annual? No, we will see why. So, in January 2019, you lend you $100, and six months later, this has grown of 5%. So now is $105. And after that the 5% interest rate apply. But on the basis of these 105 figures.
00:02:06.942 - 00:02:47.422, Speaker A: So at the end, in January 2020, when you get your money back, you get $110 00:25 cent. And so this 25 cent, this is the magic of compound interest. You can see that you actually get more money than compared to when it was 10%. And so with this knowledge, will be able to calculate Defi APY. Next, I want to do a brief reminder of what is a yield farming. We always hear this word in many places, but we need to formally define it. So yield farming is a way to make money in Defi.
00:02:47.422 - 00:03:38.302, Speaker A: So let's say that you are an investor. You invest your tokens in a Defi protocol at a certain point in time, and then you wait a couple of blocks and after you withdraw your tokens, so you will have your initial tokens back plus a yield farming reward. And what is this yield farming reward where it can be broken up in two parts? The first part comes from either providing liquidity or lending. So providing liquidity, for example, will be investing your token in uniswap and becoming a liquidity provider. And lending will be investing your token in compound so that other people can borrow them. And the other part of the yield farming reward is what we call liquidity mining incentive or staking. So this is an extra reward that some DeFi protocols started to implement in order to attract liquidity.
00:03:38.302 - 00:04:23.114, Speaker A: So with this kind of reward in general, you get some governance token for providing liquidity or lending your token. And these governance token, even if you don't care about their utility, they still have a market value. So you can resell them. And this will actually boost your yield. Okay, so now that we understand what is a yield farming, I'm going to explain specifically how it applies to kampan. So compound is this DeFi protocol where you can borrow and lend tokens in a decentralized way. So what is very special with Kompan is that if you want to borrow token, you also need to first lend token in order to have some collateral.
00:04:23.114 - 00:05:11.550, Speaker A: So here you can see the investor on the left is both a lender and a borrower. So as a lender on compound, you get paid what we call the supply rate. So let's say that you're an investor, you invest 100 tokens in compan and the supply rate is 4%. So this is a variable rate that is valid for one block. So that means you will make 4%, but 4% is annually. So if you kept your tokens invested for one year, at the end you would get 4%. But for just one block you get the figure that if multiply by the number of block in a year, in the end result in a 4% gain, then for the next block the supply rate will change.
00:05:11.550 - 00:05:36.034, Speaker A: Because it always depend on market condition, it's recalculated for every block. So let's say now it's 5%. So for the next block you will get five cent. But once again, five cent is an annual rate. So what you get is much smaller. And if at the next block you decide to exit, then you'll get your 100 token plus your interest. And the other kind of reward you get on compound is the governance token.
00:05:36.034 - 00:06:04.942, Speaker A: So let's say you invest your 100 token, you keep them for one block. So you get a few comb token. The amount of token that is given between each block depend on different variable. We'll see this just after. And you see that when you withdraw your token, so you get the interest plus the token that you earn during the period. So what's the rule for distributing this token? For every block there is 0.176 comb token that are distributed for the whole protocol.
00:06:04.942 - 00:06:52.190, Speaker A: These are allocated to the different market of compound proportionally to their market value. So dai, USDC, et cetera. For example, currently die is the biggest market, so it's going to get the lion's share of the 0.176. Com token. Then within each market this amount is divided by two equally between lender and borrower. And for each side of the market, token will be allocated proportionally to the money that is lent for lenders and to the money that is borrowed for borrowers. So for example, if USDC represents 10% of the total liquidity of compound, and you have lent 50% of the total supply in the USDC market, that's the number of token that you will get for one block.
00:06:52.190 - 00:07:34.270, Speaker A: In this section I'm going to explain how you can write a node JS script to get the APY of compound. So here I have a node JS project with a couple of script and I've also installed some dependencies. So let's see what I install. So the main dependency is the library of compound, compound JS and axios. I'll explain later what it is used for. And the main script is APY one JS. So let's see how it works.
00:07:34.270 - 00:08:01.634, Speaker A: So first I imported the library of compound. Then here I define a URL to inferra. So I've already created a project in my inferra account. So this is used to connect to the ethereum blockchain. Then here we get the addresses of two smart contracts, the controller. So we're going to use this smart contract to get some info about the comp token and OpF. So it stands for open price feed.
00:08:01.634 - 00:08:45.614, Speaker A: So this is an onchain oracle that is used by compound and it allows to get the price of a various crypto assets in USD. So here to get these addresses we use the Javascript library of compound after we define a couple of constants that we will use. So C token. So C token are smart contract in compound that represent individual market like DaI, USDC, et cetera. And when you supply liquidity to each of these market, in exchange you get some c token, and this c token have eight decimal. Then here the number of blocks per days. On average there are four blocks in 1 minute because one block is 15 seconds.
00:08:45.614 - 00:09:18.382, Speaker A: So time, number of minute, time, number of power. You get the number of blocks in a day, the number of day per year. Then eth mantis, this is basically ten power 18. This is used to interpret some result of the smart contract of compound. And after I'm going to go at the very bottom of the script main. So that's where it start. So here we calculate the APY for a couple of markets, Cedar, USDC, USDT, and here.
00:09:18.382 - 00:09:51.802, Speaker A: So in this function calculate APY, we are going to calculate the two parts of the API. So the supply API, that's the interest rate you get for lending the token. And then the APY, this is an extra yield you get with this comb token reward. So first we get the number of decimal of the underlying for each market. So dAi, USDC, et cetera. Most of the time they have 18 decimal but some of them have six decimal like USDT for example. Then we get the address of the C token that we want to calculate the API for.
00:09:51.802 - 00:10:23.326, Speaker A: Then we get the supply apuI.com apui and then we display the result here, so individual result and then combined result where we basically add the supply Apui and Apui. So next let's see how these two function work. Calculate supply apui and calculate apui. So first calculate supply API. So let's go there. Okay, so we pass in the address of the C token, so CDA, CUSDC or CUSDT.
00:10:23.326 - 00:10:52.922, Speaker A: Then the ticker is just a string that represent the market. And here we are going to get a value called supply rate per block. So that's basically the interest rate just for one block. And here we use the library of compound for this. And so we need to pass it the address of the smart contract we want to read from. Then the signature of the function that we want to read from. Then we pass the provider that we define above.
00:10:52.922 - 00:11:23.554, Speaker A: That's basically the URL to inferra so that the library knows how to reach the blockchain. And after, once we have this supply rate per block, we can derive the interest rate per year. So we use the exponentiation function of JavaScript math Pow. By the way, in case you're wondering, this is not proof of work. Ha. Blockchain umore. So here we define blockchain rate per block by east mantisa because this is scale by ten power 18.
00:11:23.554 - 00:11:56.910, Speaker A: But if we want to have the interest rate in token unit, then we need to divide by this quantity. Then we multiply by the number of blocks per day to get the yield for a day. And then we add plus one. And then all of this is exponent times days per year minus one, so y minus one. Because when you calculate period, then you always have to remove one. For example, if you have two days, then the interest will compound just for one day. If you have three days, the interest will compound for two days only, et cetera.
00:11:56.910 - 00:12:27.542, Speaker A: And at the end we remove one to only keep the decimal part. And so to transform this to a percentage, we multiply by 100. So with this we have the supply apy. And next, in order to calculate the comp APY, so we have this order function. So again we get the c token and the ticker plus the number of decimal of the underlying token. And here we're going to get a couple of info. So first, the comp speed for our c token.
00:12:27.542 - 00:13:09.110, Speaker A: So this is basically the number of comp token that will be given to our market for the whole block, for the next block. So this quantity is for the whole market, it's not just for us. So we'll have to share this with the other lenders of our market. Then we have the price of the comp token in terms of us dollar by using this on chain oracle, that is called the open price feed smart contract. Then we get the total supply of our c token. This is the number of c token that were emitted. So as a lender, we do have c token, all the lender have some c token.
00:13:09.110 - 00:13:44.590, Speaker A: So this is different from the number of underlying token that was lent. And after we get the exchange rate between c token and the underlying. So this quantity tells you how much underlying token you need to pay in order to get one c token. And so with all this data, we can finally calculate our comp apy. So first we scale our exchange rate with the eth mantisa so that it's in the right unit. Same thing for the comp speed. So the number of decimal of comp token is 18.
00:13:44.590 - 00:14:07.690, Speaker A: Then for the price of comp token. So this was scaled by ten power six. So we adjust it. Then here we get the total supply in terms of USD. So we convert total supply to underlying token thanks to the exchange rate. Then we adjust for the number of decimal. And actually, I realized that I forgot one thing here.
00:14:07.690 - 00:14:56.794, Speaker A: So if we deal with stablecoin like USDT USDC, basically the price of the underlying is almost the same as its USD price, so it won't cause problem. But for other token like bat token the underlying price needs to be further converted to a USD value. So here in some cases it will not work. So actually maybe this can be left as an exercise. So you can use the price feed here to get the USD price of the underlying token. And here for the total supply, you'll have to make one more adjustment. Okay, so with all of this you can calculate the number of comp token that the whole market will get in a day.
00:14:56.794 - 00:15:30.440, Speaker A: So here you multiply comp speed by the number of blocks per day, and then you need to calculate how much of this token will come back to you. So for that you multiply divide comp per day by total supply. So this is how many token go back to you. And then we want a USD value. So you multiply by comp price. So in the end you'll get a comp yield per day, but we want it per year. So you multiply by 365 and you transform into a percentage with 100.
00:15:30.440 - 00:15:59.946, Speaker A: And with all of this, finally you get your API. So after that you can run your script. So let's run the script demonstration time. Let's pray so it doesn't break. When you do a demonstration, it's always when it break. Okay? And it works. So here for example, for USDT, it means if you lend your USDT, you'll make this percentage.
00:15:59.946 - 00:16:47.866, Speaker A: Plus you have this extra percentage with comp token rewards. So the total APY will be this much. By the way, on the website of compound, what you see is this quantity, but the comp APY is not taken into consideration. And here for USDC, for example, you can see it's higher and for die it's even higher, almost 5.5%. Okay, very good. So next I'm going to show you the other script that I've prepared because actually there was a much more simple way to do, but I wanted first to show you the hard way so that you can really understand what's going on. So here we use Axios, which is a library to do some HTTP request, and we're going to use the HTTP API of compan.
00:16:47.866 - 00:17:29.786, Speaker A: So that's the backend API they've built for our convenience. And they have an endpoint c token that gives you a lot of information about the different market, including the different API. So here we iterate through the result and for each market we are going to display the supply rate and the comp rate. So we're going to display this separately and after combine. Okay, so let's run this and let's verify that it kind of match with what we have before. So for example, Apui for die total ApUi is 5.8. We had 5.5.
00:17:29.786 - 00:17:57.606, Speaker A: So why is it slightly different? Is because they probably use a different rule for the number of blocks per year. So the rule I use was one block every 15 2nd. But I think their rule is one block every 13.15 2nd, which is closer to the historical data then for USDC 4.8. Yes, this is similar for USDC 4.4. Point eleven. Yeah, so this is quite consistent with what we had before.
00:17:57.606 - 00:18:38.606, Speaker A: So our script is working great. So there is no exact formula to calculate an APY. There are many assumptions that you need to make. For example, for the comp token that you get as reward at every block, do you just keep them or do you sell them and reinvest them? In the compound protocol, in this case, the yield will be higher. So really an API is highly context dependent. So what to do next? Well, you can build a defi dashboard where you show the API of the main defi project. And if you want to see other tutorial where you can build a full defi project on my channel, I actually have a playlist full of defi projects, so you should definitely check it out.
00:18:38.606 - 00:18:39.180, Speaker A: I'll see you there.
