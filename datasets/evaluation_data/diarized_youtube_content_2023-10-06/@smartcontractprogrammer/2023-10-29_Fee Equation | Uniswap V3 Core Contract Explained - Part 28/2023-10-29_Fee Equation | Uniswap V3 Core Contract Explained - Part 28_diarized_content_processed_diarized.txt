00:00:00.330 - 00:00:39.126, Speaker A: Starting from this video, I'll explain how the unisoft b three fee algorithm works. So for the first video, I'll explain how to calculate fees. Imagine that on the vertical axis we graph the liquidity, and on the horizontal axis we graph the price. Let's say that the current price is over here. To the right of this current price, all liquidity will be in token x, and to the left, all liquidity will be in token y. Let's also say that Alice has s shares of liquidity from here to here, and bob swaps some amount of token y dy for some amount of token x dx. Let's say that this swap shifted the current price from here to here.
00:00:39.126 - 00:01:19.926, Speaker A: So active liquidity was over here. And after the swap, let's say that the active liquidity is over here. Since the token that came in was token y, fee is collected on token in which is equal token y. We'll say that the amount of fee that was collected in L zero, the total amount of fee that was collected in l zero when Bob did a swap is f zero, and the amount of fee that was collected inside of liquidity l one. We'll call this f one. And again, both f zero and f one are in token y since these are the tokens that came in. So in this single swap, remember that Alice has s shares in a liquidity that is shaped like this.
00:01:19.926 - 00:02:03.890, Speaker A: Let's calculate how much fee Alice now gets from this swap. What we're going to calculate is the amount of fee that Alice earned for providing liquidity. Let's call this f f will be the total fees earned by Alice, and this will be equal to f zero. This is a total amount of fees that was earned from bob swapping in liquidity zero. And how much of this f zero should alice be able to claim? Well, it will be the amount of liquidity that she owns in l zero. The total liquidity that she earns inside l zero is s, and the total liquidity for this l zero is l zero. So in this liquidity l zero fee that was generated was f zero, and Alice gets to have a portion of it.
00:02:03.890 - 00:02:32.890, Speaker A: And the portion will be s divided by l zero. Okay? And we do the same for f one. The total fee that was collected is f one. The amount of liquidity that she has in this position is s, and the total liquidity in l one is l one. From f one, the total amount of fee that was generated in this swap. In the liquidity l one, alice gets a portion of s divided by l one. And this is the total fee that was earned by alice in this swap.
00:02:32.890 - 00:03:12.378, Speaker A: This is the total fee that was earned by alice when Bob did a swap. This was a single swap. But what is the equation when there are multiple swaps? So we'll come up with a general equation for the total fees that was earned by alice after she provides some liquidity, there will be some multiple swaps. And over time, what is the amount of fee that alice earned? To answer this question, let's come up with some variable names that incorporate time. We'll define l I of t to be equal to liquidity in tick I at time t. Now, why do we need to incorporate time? Well, this is because liquidity changes over time. People put in liquidity, and people withdraw liquidity over time.
00:03:12.378 - 00:03:49.574, Speaker A: And we also define f of iot to equal fee of token y collected in L iot. In other words, this is the fee of token y that was collected inside liquidity at tick I at time t. Okay, so let me give you an example of what I mean here. For example, let's say at time t equals zero, we have a liquidity that looks like this. And let's also say that alice provided this much liquidity in between these ticks. You'll say that this is tick zero and this is tick one. At t equals zero, someone did a swap, and this shifted the active liquidity from tick zero to tick one.
00:03:49.574 - 00:04:31.458, Speaker A: This collected f zero of zero for fees on liquidity zero and f one of zero. At liquidity one at t equals one. Let's say that the liquidity has changed, and this is because some people added more liquidity and other people have removed liquidity. However, let's say that alice has not changed their position, so her liquidity is what's shown in pink. It has not changed since time t equals zero. A swap caused the price to move from tick one to tick minus two, so the active liquidity shifted from l one to l of minus two. Since we defined f of Iot to be the fee collected on token y, the amount of fee that was collected here is equal to zero.
00:04:31.458 - 00:05:03.086, Speaker A: Since the token that came in is token next and not token y, we only collect fee on token that comes in. So in this case, fee collected from l one all the way to l minus two. At each of these, liquidity is equal to zero f of I one is equal to zero at t equals two. Again, liquidity changed. However, alice's position remains the same. A swap for token y to token x caused the price to move to the right. The active liquidity shifted over from l of minus two to l of zero.
00:05:03.086 - 00:06:06.354, Speaker A: This collected a fee of f of minus two at liquidity l minus two, f minus one at liquidity minus one, and f zero at liquidity zero. Notice here that in this example, the variables l of Iot and f of Iot are indexed by the tick position and also by time. Okay, so what is the general equation for the total amount of fees earned by alice from t equals zero to t equals two? Alice provided s liquidity showing pink swap collected fee of f I of t from liquidity li of t at time t. To answer the question, how much fee did Alice earn from time t equals zero to t equals two? We ask a simpler question first. What is the amount of fee that Alice earned at t equals zero? What is the amount of fee that Alice earned at t equals one? And what is the fee that Alice earned at t equals two? If we sum all of these up, we should get our answer. So let's try to answer the simpler question. What is the amount of fee earned by Alice at time t? We'll call this f of t.
00:06:06.354 - 00:07:08.546, Speaker A: And what is this equal to? Well, going back to our first example, we can see that the fees earned in this example was f zero times s divided by l zero plus f one times s divided by l one. So if we replace this variable with the variables over here, then we should get a general equation for the amount of fees that Alice earned at time t. So scrolling down, here's the general equation for fee earned by alice at time t f of t will be equal to the sum of fees collected in between the ticks F of iot. And then we multiply this by the ratio of amount of liquidity that ALice has at l of iot. Now, since s is a constant inside estimation, we can pull this out to here and then just bring this over to the top. And this will be the equation that we'll be using for f of t. Now we can answer the question, what is the total amount of fees earned by Alice from time t zero to, let's say some t t of n.
00:07:08.546 - 00:07:46.426, Speaker A: We'll call this f and f is equal to. All we have to do is take the sum from t equals to t zero to all the way up to t n and we sum up this equation f of t. And this will be the total amount of fees earned by Alice from t zero to tn. And here we're assuming that alice's liquidity is a constant s. Now, before we go, take a look at this equation over here. Why did I rearrange this equation to look like this? Well, here s is a constant. So this means that if we track this expression, then we'll be able to calculate fees for any users.
00:07:46.426 - 00:07:54.140, Speaker A: This is the same trick that is used in the synthetics staking rewards contract. I'll end it here for this video. I'll see you in the next one.
