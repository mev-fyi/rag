00:00:00.650 - 00:00:34.230, Speaker A: In this video, I'm going to show you how to add liquidity to the curb stableswap contract. There are a couple ways to remove liquidity, so I'll also show you that. And there are two ways to calculate how much stablecoins you can withdraw from the curb contract. So I'll also explain that. But first, let's take a look at the user interface. You can deposit your stablecoins into curb and earn trading fees. For example, if I were to deposit 300 die, then I would get 292 LP tokens.
00:00:34.230 - 00:01:12.110, Speaker A: Likewise, if I were to put 300 USDC, I will get 291 LP tokens. And if I were to put 300 USDT, I would get again 292 LP tokens. You can also deposit multiple coins at once. For example, I put in 100 die, 100 USDC, and 100 USDT. That will give me 292 LP tokens. The amount of LP tokens that you will receive depends on two things. One is the amount that you're going to deposit, and other factor is the balance of the pools.
00:01:12.110 - 00:02:09.778, Speaker A: And you'll get more LP tokens for depositing coins with a lower balance. So here, I would get more LP tokens if I were to deposit into Dai or USDC. Over depositing into USDC, let me show you an example. If I were to deposit 1 million die, then I would get 973,922 Lp tokens. Likewise, if I were to deposit 1 million USDT, I would get 974,020 Lp tokens. However, if I were to deposit 1 million USDC, I get 972,779 LP tokens, which is the lowest of LP tokens that I would get. Among these three coins, the amount of LP tokens that we have represents the amount of stable coins that we can later withdraw from curb.
00:02:09.778 - 00:02:32.610, Speaker A: Let's say that I have 100 Lp tokens. How much stablecoins can I withdraw? Well, I'll be able to withdraw these amount in stablecoin. Here, I think there's a bug. I think that these number needs to be multiplied by ten. So instead of getting 1.86 die, I should be able to get 18.6 die.
00:02:32.610 - 00:03:16.410, Speaker A: Anyways, we can also decide to withdraw from one coin. So for example, I want to only withdraw in die. So I click here and I will get this much amount of die. Likewise, I can click on USDC and also on USDT. Okay, so back in our contract, let's now write some code to add liquidity, remove liquidity, and also calculate the amount of stablecoins that we can withdraw once we have the LP tokens. First, I'm going to define some addresses, the address of the stable swap contract and the address of the LP token. The address of the three stablecoins, and then we'll put this into an array.
00:03:16.410 - 00:03:52.486, Speaker A: Let's start with the function add liquidity. How do we deposit our stablecoins into the curve contract? We'll first initialize some variables, tokens and balances. We'll run a for loop to store the balance of each stablecoin into the array balances. If the balance of the token is greater than zero, then we'll approve the swap contract to be able to spend from this contract. However, there's a catch here. ERC 20 approve expects the output to be true. However, USDT does not return true.
00:03:52.486 - 00:04:27.070, Speaker A: So when we call this function, this line of code will fail on USDT. So we need a way to say if the token is equal to USDT, then ignore the output. Otherwise, check that the return is equal to true. We've seen this problem before. Inside the curve contract under the function exchange and the way they solved it is using this code over here. So we'll copy this code and then modify it a little bit. Back inside our contract, I've created a function called safe approve.
00:04:27.070 - 00:05:16.558, Speaker A: It's going to take in the address of the token, the address of the spender, and the amount that the spender is allowed to spend. I've copied the code over from the curb contract and now we'll modify it. We'll change the input coin to token, and then we'll change the function signature from transfer from to approve. The approve function takes in two parameters of address and un, and the two parameters are spender and amount. Now we have an ERC approved function that can handle whether or not this approved function returns an output true or not. Scrolling back down. We will replace this ERC 20 approve with this function over here.
00:05:16.558 - 00:06:09.038, Speaker A: This internal call to the safe approve after we approve the stable swap contract to spend tokens from this contract, we'll actually deposit the coins into the stable swap contract by calling add liquidity, putting in the balances and the minimum amount of LP tokens that we expect to receive. We'll set it to one. And that is how you deposit stablecoins into the curb contract. Adding liquidity curb contract will mint LP shares to this contract, and we can get the amount of shares by calling the LP contract balance of this contract. Once we have LP tokens, we'll be able to withdraw stable coins in exchange for the LP tokens. So let's now talk about how to remove liquidity. There are several ways to do it, but I'll show you two examples.
00:06:09.038 - 00:06:58.258, Speaker A: Remove liquidity which will withdraw all three tokens, and also remove liquidity one coin which we'll be able to withdraw only in one coin that we specify. First, let's take a look at remove liquidity. We'll first get the shares the amount of LP tokens locked in this contract. For simplicity, we'll say that the minimum amount of stablecoins that we expect to receive is all zeros, and we can withdraw stablecoins in exchange for our shares by calling remove liquidity, passing in the shares, and passing in the min amounts to remove liquidity and withdraw only in one stable coin. We can follow a similar step. We'll get the shares locked in this contract. We'll set min amount equal to one.
00:06:58.258 - 00:07:48.050, Speaker A: Then we call remove liquidity one coin. Given the amount of shares, is there a way to know how much tokens that we will receive when we call remove liquidity one coin? There are two ways to estimate the amount of tokens that we'll be able to withdraw. Let me explain. I've created a function called calc withdrawal one coin. It's going to take in the index of the coin that we wish to withdraw, and it's going to return to un, which represents the two ways of calculating how much tokens we are able to withdraw. First, we'll get the shares. The first way to calculate the amount of stablecoins that we can withdraw is by calling the function calc withdrawal one coin passing in the amount of shares, and passing in the index of the token that we wish to withdraw.
00:07:48.050 - 00:08:46.638, Speaker A: The second way is to calculate the value of stablecoin per shares by calling the function get virtual price and then multiplying this virtual price by the number of shares. Here, we'll need to divide by ten to the 18, because both of these have 18 decimal places. Now this get virtual price. What is it actually doing? Let me give you a quick explanation. Recall from a previous video that d has a special meaning, and the constant d represents the total amount of coins when they have an equal price. For example, let's say that die, USDC and USDT all are equal to $1, and we'll say that there are 100 die, 100 USDC and 100 USDT. Then in this case, d will be equal to 100 plus 100 plus 100, which is equal to 300.
00:08:46.638 - 00:09:26.420, Speaker A: Inside the curve contract and inside the function get virtual price. You can see that it gets the value of d, it gets the token supply and divides the both. In other words, this get virtual price function approximates price of stablecoin per share how much stablecoin is each share worth. So these are two ways to calculate the amount of stablecoins that you can withdraw. Given the amount of shares calc, withdraw one coin and get brochure price multiplied by shares. I've written a test. Let's take a quick look at what it does.
00:09:26.420 - 00:10:20.078, Speaker A: First, it's going to deposit some stable coins into the contract. Next, we'll add liquidity and then print out how much shares we got back. Next we'll call remove liquidity and then we'll see how much DI USDC and USDT we got back in return. Next, we'll add liquidity again and then call the function calc withdrawal one coin to see the difference between calc withdrawal one coin and shares times virtual price. And then finally we'll call remove liquidity one coin and then print out the balances. I've started ganache on the main net fork and open another terminal and we'll run the test. In this test, I've deposited 1000 USDC and in return I got 922 LP tokens.
00:10:20.078 - 00:11:13.740, Speaker A: When we called remove liquidity, I got 184 die, 639 USDC and 174 USDT. And then we add liquidity again. And then we call the function calc withdrawal one coin which says that it can return 999 USDC. In comparison, when we multiply the shares by virtual price, we get similar number and then actually calling remove liquidity one coin, we get back 999 USDC. Okay, so that was a video about how to deposit into a curve contract, remove liquidity in several ways, and also calculate the amount of stable coins we expect to get back given the amount of shares. Thanks for watching.
