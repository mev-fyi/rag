00:00:00.250 - 00:00:35.782, Speaker A: What is the optimal amount of token to put in into two uniswap B? Two contracts to maximize an arbitrage opportunity. There's actually an exact formula for this, so in this video I'll explain what it is and how to derive it. Let's begin by imagining that there are two uniswap B, two amms, amma and ammb. Both of these curves are the constant product x times y equals k. Now, let's also say that both of these amms are selling the same tokens. And we observe that on amma the price is cheaper than on ammb. On amma we have P of A, and on ammb we have b.
00:00:35.782 - 00:01:08.410, Speaker A: Here we have an arbitrage opportunity. What we'll do is buy some token from Amma. This will bring the price up to, let's call this pstar. And then taking the same token that we just bought, we will sell it on ammb. This will bring the price of token on ammb from PoB to Pstar when the prices match on amma and ammb. This means that there is no more arbitrage opportunity. Okay, to execute an arbitrage here, what we'll do on amma is we'll need to bring the price up from P of a to this p of start.
00:01:08.410 - 00:01:33.018, Speaker A: And to do this, we'll put some token y in. Let's call this dy of a, and then we'll get back out token x. Let's call this minus dx. Next on ammb, we will sell this same exact amount of Dx on ammb. When we sell this token x, we get back token y. Let's call this dyb. To summarize here, what we did was we put in Dya of token Y.
00:01:33.018 - 00:02:19.222, Speaker A: Then at the end of the arbitrage, we got back dyb of token y. The profit from this arbitrage will be the final amount of token y that came out minus the initial amount of token y that we put in. Let's write this as an equation. We'll define a function that will represent the profit from this arbitrage. Let's call this capital F, and for the input, it's going to take in dy of a the initial amount of token y to put in to execute this arbitrage, and the profit will be the final amount that came out minus the initial amount that we put in. Now, we can rephrase our question of what is the optimal amount of token to put in to maximize arbitrage profit. We can rephrase this as what is the dya that we need to put in here to maximize this function f.
00:02:19.222 - 00:03:02.358, Speaker A: Let's call this dy of a of start. This will be the amount in that maximize f. When we maximize this f, this also means that we're maximizing this value which is the arbitrage profit. There's actually an exact formula for this dy of a of star, and it turns out to be this complicated equation where a is equal to this, b is equal to this, c is equal to this, and then k is equal to this. When you plug these numbers in and then calculate this equation, you'll get the optimal amount of token in to maximize arbitrage profit. For the rest of the video I'll explain how to derive this equation and I'll start by explaining what these variables mean. First, I'll define what f is.
00:03:02.358 - 00:03:40.354, Speaker A: F is the swap fee. We will assume that on amma and on ammb we have the same swap fee. This swap fee will be a number between zero and one xa. We'll define it as amma reserve out. Here, reserve out means the balance of the token that is coming out that is locked inside Amma. For our example, on Amma, token that is coming out is tokennex. So in this case, xa will represent the token balance of tokennex in Amma, and ya will be Amma's reserve in.
00:03:40.354 - 00:04:15.194, Speaker A: Again, going back here, the token that is going in inside this amma is token y. So ya will be the amount of token y locked inside Amma and we'll define similar variables for ammb. Xb will be equal to ammb reserve in. Yb will be ammb reserve out. Okay, going back to our example, in our example, xb is ammb reserve in. So the token that is coming in in this example is tokennex. The balance of token.
00:04:15.194 - 00:05:01.530, Speaker A: Next, locked inside ammb will be xb and the token that is going out in ammb is token y. So the balance of token y inside ammb is yb. Now with these variables defined and using this equation you can plug in the numbers to calculate what dy of a of star is. Through the next part of the video I'll explain how to derive this equation. I'll start by writing out the equation that calculates the amount of token that comes out in a constant product amm. So when you put token in, the amount that comes out, we'll call this swap amount out and we'll define it as a. About is given by this equation where a in is the amount in, r in is the reserve in and r out is reserve out.
00:05:01.530 - 00:05:36.582, Speaker A: This is the same exact equation that you'll see in unison B, two contracts. Okay, using this equation, let's calculate the amount of token that comes out on Amma. The token that is going to come out from the first swap is dx, and the token that's going to go in is dy of A. So we'll rewrite this equation in terms of dx, dy, x of a, and Y of A. Okay, we'll start with a out, a out. The token that is coming out from the first swap is dx. Then next I'll replace an the amount of token that's going in.
00:05:36.582 - 00:05:58.942, Speaker A: So I'll remove this and then also remove this. An will be dy. Obey. Okay, how about R out? R out is reserve out. The token that is coming out from the first swap is token X. So reserve out will be x of a reserve of token X on Amma. Okay, lastly, we'll replace Rn reserve in.
00:05:58.942 - 00:06:22.006, Speaker A: The token that is coming in is token Y. So this will be y of a. Next, we'll do the same for swap on ammb. On ammb, the token that is coming in is token X, and the token that is going out is token Y. So first again, I'll copy this equation, then paste it here. Let's start with a out. The amount of token that is coming out.
00:06:22.006 - 00:06:37.354, Speaker A: We define this as Dyb. The amount of token that is going in is the amount of token that came out from the first swap. So this will be dx. So I'll put dx over here. And I'll put dx over here. Okay, next let's replace R out. Reserve out.
00:06:37.354 - 00:06:58.238, Speaker A: The token that is coming out on ammb is token y. So reserve out. On ammb is yb and reserve in will be Xb. We're putting in DX token. So the token that's coming in is token X. The reserve of token x on ammb is represented as Xb. So now we have some equations.
00:06:58.238 - 00:07:26.858, Speaker A: The next thing that I'll do is I'll replace this dx with this equation over here. So I'll start with the top part. I'll bring this over here, then replace this dx with this equation. So on the top we will have this equation. Then next I'll replace this dx. So I'll bring this over here and then copy this equation again, paste it here, and we have this equation. So our equation will look like this.
00:07:26.858 - 00:07:55.410, Speaker A: Next, let's simplify this equation. So I'll copy this and then I'll paste it here for now, this equation is the same as doing this, having a one here. And then I just brought this over to the left. And now I see that for the top part, I can just put this. Then on the bottom. I'll need to multiply this term by these terms. When I multiply by the first term, I'll get this multiplied by x of b.
00:07:55.410 - 00:08:32.574, Speaker A: And then when I multiply this again with the second term. So I'll need to multiply this with this. Notice for the second term that these terms cancel out with these terms on the bottom, they are the same, so I can just simply remove them. Okay, so this term is equal to this term, and I can further simplify the terms. I see two one minus f on the top. So I can just replace it with one minus two f square. And then on the bottom, I'll do the same.
00:08:32.574 - 00:09:03.638, Speaker A: I see two one minus f. So this will become one minus f square. Next, I'll simplify the bottom terms. So this is equal to. I'll expand the first term. So this will be ya multiplied by xb plus dy times one minus f multiplied by xb, and then plus these terms. And the last thing that I'll do for this equation is I'll group all of the terms that have a dy obey.
00:09:03.638 - 00:09:40.086, Speaker A: I'll copy this and then paste it here. And what we have here is dy oba times one minus f plus x, sub b plus dy ob square times x, sub a. And I'll put these terms inside apprentices. And now we can replace this term. Okay, so that completes dy of B. What we did here was we rewrote dy of b in terms of dy of a, going back. And now we can rewrite this equation to find dy star of a.
00:09:40.086 - 00:10:30.854, Speaker A: So I'll copy this equation and then paste it here. So now we know what dy of b is in terms of dy of a. Now we're ready to tackle the question, what is dy of a of star, which is the amount that will maximize f? To find this answer, we'll use calculus to take the derivative of f with respect to dy of a and find where the derivative is equal to zero. We'll call this point where the derivative of f is equal to zero, dy of a of star. So, if you remember, in calculus, if you find a point where the derivative is equal to zero, this means that the function either reached a maximum or a minimum with our function. This point where the derivative is equal to zero is the point where the function reaches its maximum. Okay, so the next step is to find the derivative of f.
00:10:30.854 - 00:11:03.840, Speaker A: Here's the function f. Again. When we take a derivative of this function f, let's call this f prime. Then we'll need to take the derivative of dy of b, which is this equation over here. And taking the derivative of dy of a with respect to dy of a, this will be equal to one. But what is the derivative of dy of b? What we need to do is take the derivative of this complicated equation with respect to dy of a. So, I'll start by copying this equation over to here.
00:11:03.840 - 00:11:37.260, Speaker A: Furthermore, I'll break this equation down into two parts. The top part, I'll define it as f, and the bottom part, I'll define it as g. Next, to find the derivative of dy of b using the quotient rule of derivatives, this is equal to f prime times g minus f times g prime divided by g squared. So the next step is to find all these terms, f prime, g prime, and g square. Let's start with f prime. We said that the f is the top part of this equation. So I'll copy this.
00:11:37.260 - 00:12:06.846, Speaker A: So this is f, and we need to take the derivative of this with respect to dy of a. When we do that, we're treating this part as a Constant, and this will be the derivative. Next, we'll do the same for g prime. The derivative of g with respect to dy of a g is equal to this term. Next, we'll take the derivative of this equation with respect to dy of a. When we take it respect to dy of a. The first term is just a constant, so it disappears.
00:12:06.846 - 00:12:32.202, Speaker A: The next term, we have a dy of a. When we take the derivative, this will become one, and we treat this part as a Constant. Next, we have a dy of a. When we take the derivative of dy of a, this will be equal to one, and we're left with these terms. Okay, the next step is to calculate f prime, g minus f times g prime. So this will be equal to f prime. G is this term.
00:12:32.202 - 00:13:00.120, Speaker A: Next, we multiply this by g. G is equal to these terms. Next, we'll have a minus, and f is equal to these terms. And g prime will be equal to these terms. This is equal to. I'll first expand the first term. Then next, I'll expand the second terms.
00:13:00.120 - 00:13:29.546, Speaker A: Next, a lot of the terms that you see over here will cancel out. This term over here will cancel out with this term. And to see this? We have a one minus f square over here. And we also have one over here. The same over here, same over here. We have an x a x a dya, dya over here, and xa times yb, which we also have over here. So all of these terms cancel out with all of this term.
00:13:29.546 - 00:14:14.750, Speaker A: Next, this term will cancel out with this term. And to see this, we have a dy of a times one minus f. We have a dy of a one minus f times x b times xb. And we multiply this term by one minus f squared times x a times y b, which we have over here. So what we're left with is just the first term, which is one minus f square times x a times y b times ya. And this ya will be multiplied by this xb. And this is our result for f prime times g minus f times g prime.
00:14:14.750 - 00:14:39.190, Speaker A: We'll come back to this equation later. The next step is to find g square. We said that this is equal to g, so g squared will be squaring these terms. I'm going to rearrange this equation so that all of the terms that have a dy of a will be in one place. So I'll copy this again. First, we have this term. I'll bring this over here.
00:14:39.190 - 00:15:09.102, Speaker A: Then we also have a dy obey over here. This is equal to dy times one minus f times xp. So, I'll bring this over here, and then remove this dy of a, and then wrap these two terms in apprentices. And then I can remove this term. So, now we have y a times xb plus these terms. So this is the inside part of this square. So we need to square this again.
00:15:09.102 - 00:15:50.522, Speaker A: And to simplify the equation, I'll relabel this part. You'll say that this part, I'll redefine it as k k will be equal to this terms underlined in orange. The reason why I relabeled these terms as k is so that the equation will be short. Now, we can simplify this equation. The first term will be k squared times dy of a square. The second term will be two k times y a times x b that you see over here, times dy of a, and the last term will be y a times x b square. Okay, we did a lot of calculation, and we're finally ready to find dy of a of start.
00:15:50.522 - 00:16:34.634, Speaker A: This will be the optimal amount that will maximize the function f, which is also equal to where the derivative of f is equal to zero. First, I'm going to scroll back up, and I'll copy this equation and then paste it here. Next, I'll take this equation and then paste it here. Next, I'm going to combine these two equations so that we'll be able to find dy of a star where the derivative is equal to zero. First, I'll start with this. So, from this, we're trying to find dy of star where this is equal to zero. And then I'll remove this.
00:16:34.634 - 00:17:09.400, Speaker A: This is the same as finding the derivative of dyb where it is equal to one. And we know that dy of b is given by this equation. So, I'll replace this with this equation. And now, this condition is the same as finding where f prime times g minus f times g prime is equal to g square. Okay? And we already know what all of these terms are. The first term, the term on the left is equal to this. And we also know the term on the right g square.
00:17:09.400 - 00:17:38.670, Speaker A: G square is given by this term. And to find a place where this is equal to zero, we can use the quadratic formula to find the root. And to find where this equation is equal, we can use the quadratic root formula to find where dy of a is equal to zero. So this is equal to. I'll flip the equation first. So these two equations are the same. And this will be equal to saying that this whole equation is equal to zero.
00:17:38.670 - 00:18:21.354, Speaker A: We relabel this k square. The first term, the first term that's multiplied by dya of square. We redabel this as a. We relabel the second term that's multiplied by dy of a as b, and we relabel the last terms that doesn't have any multiplication by dy of a as c. With these ABC terms defined, we can now use the quadratic root formula to find where dy of a is equal to zero. And here is one of the quadratic root formula minus b plus square root of b squared minus four ac divided by two a where ABC are defined over here. Plug all of this in, and this is equal to dya of star.
00:18:21.354 - 00:18:50.370, Speaker A: When you plug ABC into this equation, this will give us where this equation is equal to zero. And when this equation is zero, we know that this condition is true. And when this condition is true, we found dy of a where the derivative is equal to zero, and where this derivative is equal to zero. This is where the function f is maximized. In other words, this tells us the optimal amount of token in. To maximize profit for a uniswap, b, two contracts.
