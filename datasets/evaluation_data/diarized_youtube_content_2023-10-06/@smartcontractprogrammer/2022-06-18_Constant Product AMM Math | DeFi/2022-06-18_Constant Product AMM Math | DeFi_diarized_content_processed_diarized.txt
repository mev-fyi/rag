00:00:00.330 - 00:00:38.694, Speaker A: Constant product automated market maker. I'll explain what it is, and I'll explain the math behind swapping, adding liquidity, and removing liquidity. A constant product amm is an amm where the price of tokens are determined by the equation x times y equals k, where x is the month of token a in the amm, and y is the month of token b in the amm. When you do a trade in this amm, x and I can vary, but k, the constant, must remain the same. Let me show you an example. So for example, we'll say that we'll sell token a and buy token b. Since we're selling token a, that means token a is coming in.
00:00:38.694 - 00:01:08.130, Speaker A: So dx is the amount of token a that is coming in. And since we're buying token b, token b is going out. So we'll say dy is equal to the amount of token b that is going out. Before the trade, we have the equation x times y equals k. After the trade, we have x plus dx amount of token a times y minus dy amount of token b. X is the amount of token a that was in the amm before the trade. And since we're selling token a, dx amount came in.
00:01:08.130 - 00:01:39.658, Speaker A: Y is the amount of token b that was in the amm before the trade. And since we're buying token b, some of this amount went out. So that is why you have minus dy, and this must still be equal to k before the trade. And after the trade, k must be a constant. Let's take a look at what this will look like in a graph. We'll say that the horizontal axis represents the amount of token a in the amm, and the vertical axis represents the amount of token b that is in the amm. We'll say that the graph of x times y equals k looks like this.
00:01:39.658 - 00:02:43.390, Speaker A: And before the trade, amount of token a in this amm, we'll say is somewhere over here, and the amount of token b inside imm is somewhere over here. When we do a trade for this example, we're saying we're selling token a, so token a is coming in. This means that x is going to decrease by dx, so it's going to move over to the right, and the new amount of token a inside the amm is over here. Now, for this k to not change, y must be a point somewhere on this graph. Since the new x is over here, the new y must be over here. Notice that we increase the amount of token A from x to x plus dx, and for k to still remain the same, we had to decrease y from Y to Y minus dy. But what is this dy? If we know the amount of token A and the amount of token B that will be x and y, and the amount of token a that we're selling dx, then in terms of x, y, and dx, what is dy? Let's find that out when we do a swap from either token a to token B, or from token B to token a.
00:02:43.390 - 00:03:19.290, Speaker A: How many tokens to return in a trade? The answer to this question, how many tokens to return in a trade? Is that dy is equal to y times dx over x plus dx. So let's see why this is the answer. For this example, we'll swap from token a to token b for the math that I'm about to show you. We'll say that we'll swap from token a to token b. But the math also works the other way, from token b to token a. Okay, let's say that dx is the amount of token a that is coming in, and dy is the amount of token B that is going out again. Before the swap, we have the equation x times y equals k.
00:03:19.290 - 00:03:57.270, Speaker A: X is the amount of token a in the amm, and y is the amount of token b in the amm. After the trade, we have that the amount of token a in the amm is x plus dx. We had x before, and dx amount of token a came in times y minus dy. Y is the amount of token b that was in the amm before the trade, and dy amount of token b went out. So that will be y minus dy. Multiplication of x plus dx times y minus dy still must remain the same constant k. We know what x and y are, and we also know what dx is the amount of token a that we're putting in.
00:03:57.270 - 00:04:39.478, Speaker A: So, in terms of x, y, and dx, let's find out what dy is equal to. What is dy equal to? Well, from the equation above, we can divide the whole equation by x plus dx on both sides, and on the left side we get y minus dy. That's this part of the expression that you see. And on the right side we have k divided by x plus dx. We can move the y over to the other side of the equation and then multiplying both side of the equation by negative one, and we get that dy is equal to y minus k over x plus dx. Now, notice that k over here we can replace it with x times y equals k. X times y is equal to k.
00:04:39.478 - 00:05:19.298, Speaker A: So we can replace this k with x times y. We replace this k with x times y and we get that dy is equal to y minus x times y over x plus dx. Let's further simplify this equation. We multiply y by this denominator x plus dx, so that we can put this whole expression in a fractional form. And we get that y times x plus y times dx minus x times y over x plus dx. Now notice that we have y times x and minus x times y. These two are equal and they cancel out y times x minus x times y.
00:05:19.298 - 00:06:03.966, Speaker A: Finally, we get the final expression that dy is equal to y times dx over x plus dx. And this is our answer to our question. How many tokens to return in a trade? We said that we're swapping from token a to token b. So dy is equal to y times dx over x plus dx. Now the way we derive this equation, we can also run it in the opposite direction, saying that we swap from token b to token a and you'll get that dx is equal to x times dy over y plus dy. When you add liquidity to a constant product amm, how many shares should it mint? The answer is s. The shares to mint is equal to dx the amount of token a that goes in over x.
00:06:03.966 - 00:06:50.558, Speaker A: The amount of token a that is inside the amm times t the total shares. And this happens to equal dy the amount of token b that is going inside the amm over y the amount of token b inside the amm times t the total shares. Let's see how to come to this conclusion. Now remember that when we add liquidity to a constant product amm, it has two tokens, token a and token b. So the first question that we need to ask is, how many token a and token b can we add? Is there some kind of restriction to the amount of token that we can add? How many dx and dy to add before adding liquidity? The curve that we're trading on is x times y equals k. X and y are amount of tokens inside this amm. After we add liquidity, we have a new curve that we're trading on.
00:06:50.558 - 00:07:41.978, Speaker A: X plus dx times y plus dy is equal to k prime. Now, as a side note, notice that since dx and dy are both positive terms, then this whole expression x plus dx times y plus dy must be greater than the original expression x times y. In other words, k must be less than or equal to k prime. So now when we have liquidity, what are some constraints on the amount of tokens that we can add? Well, the constraint to have on dx and dy, the amount of tokens that we're adding, is that no price change. Before and after adding liquidity, the price of tokens are determined by the ratio of the amount of tokens in the amm. So the price of tokens before adding liquidity can be determined by the ratio x over y. This must be equal to the ratio after adding liquidity, x plus dx over y plus dy.
00:07:41.978 - 00:08:25.802, Speaker A: Let's see this on a graph. What does this constraint look like on a graph? So before adding liquidity, we have this purple curve representing x times y equals k. X is the amount of token a that is inside the amm, and y is the amount of token b. After adding liquidity, we will increase the amount of both tokens, both token a and token b, and also shift the curve that we're trading on to the right and to above, so that the new curve would look something like this. So now if we were to add dx and dy amount of tokens, what would this constraint look like on the graph? Let's start with the left side of this equation. X over y. X over y is the ratio of tokens inside the amm on a graph.
00:08:25.802 - 00:09:20.174, Speaker A: We can think about this as a slope, which you can see over here as a blue dotted line. This slope before adding liquidity and after adding liquidity, must be the same. So this means that before adding liquidity were over here on this blue line, then after adding liquidity, the new x and y must also be on this line. So this means that if we were to put in some amount dx amount of token a, and since the new dy must be on this blue dotted line, then for this example, dy would be somewhere over here that is also on this line. This is the graphical explanation of what this constraint is describing. That when you add liquidity, the amount of dx and dy must also be on this blue dotted line that is defined by the original ratio of x over y. Let's see what the actual amount of dx and dy are.
00:09:20.174 - 00:10:22.350, Speaker A: We will ask two questions. What is dy given dx? In other words, if we know the amount of token a that we want to add, what is the amount of token b that we also need to add? And likewise, what is dx given dy if we know the amount of token b that we want to add, then what are the constraints on the amount of token a that we can add? We'll start with the question, what is dy given dx? We'll start with this expression. So x over y is equal to x plus dx over y plus dy. The ratio of amount of tokens in the amm before adding liquidity, and the ratio of the tokens after adding liquidity are the same. This is what this equation is describing. We can multiply the left side of the equation by y plus dy, and the right side of the equation by y and we get x times y plus dy is equal to y times x plus dx. We can expand this equation and we get x times y plus x times dy is equal to y times x plus y times dx.
00:10:22.350 - 00:10:54.542, Speaker A: Now notice that on both side of the equation we have x times y and y times x which are equal. So we can cancel them out. Dividing both side of the equation by x, we get our final solution. Dy is equal to y times dx over x. Now we can do something similar to also find dx. Starting here and solving for dx, you'll get that dx is equal to x times dy over y. We can also summarize these two equation in something that is more easier to remember.
00:10:54.542 - 00:11:39.398, Speaker A: That dx over dy is equal to x over y. The ratio of amount of tokens to add must be equal to the ratio of tokens before adding liquidity. So going back to our original question, when we add liquidity, what is the constraint on dx and dy? How many dx and dy to add? The answer is that we are restricted by this equation. Dx over dy must be equal to x over y. So next I want to answer the question, how many shares to mint? Just like the math that you saw for bolts and for constants on amm, increase in liquidity is proportional to increase in shares. For example, if we increase the liquidity by 10%, then the total shares must also increase by 10%. Let's write this as an equation.
00:11:39.398 - 00:12:08.806, Speaker A: We'll say that l zero is total liquidity before adding liquidity. L1 is total liquidity after t is the total shares before minting, and s is the amount of shares to mint. Increase in liquidity is proportional to increase in share means that l one over l zero. This is the increase in liquidity must be equal to increase in shares. T plus s over t. To find how many shares to mint we need to solve for s. So let's find s.
00:12:08.806 - 00:13:08.274, Speaker A: We can multiply both side of this equation by t and we get that l one over l zero times t is equal to t plus s. Bring this t on the right side over to the left side, and we get l one over l zero times t minus t is equal to s. Simplify this equation and we get that s is equal to l one minus l zero over l zero times t. And that answers our question. How many shares to mint? We need to find s, and s is equal to this equation over here. But notice that for constant product amm, when we add liquidity, we're adding token a and token b. So how do we measure liquidity? What is l zero and l one in this equation? And how do we measure total liquidity given x and y? How do we measure total liquidity from x and y? So we need to come up with a function where it takes in two inputs the amount of token a and amount of token b, and it outputs a single number that represents total liquidity for constant product amm.
00:13:08.274 - 00:13:45.278, Speaker A: A good solution for a function that measures total liquidity is f of x and y is equal to the square root of x times y. So let's see why the square root of x times y is a good function to measure total liquidity. Let me give you a motivation reason why total liquidity measured by square root of x times y is a good idea. Let's say that the current curve that the amm is trading on is x times y equals k. We can visualize this as the area of a rectangle. X times y equals the area of the rectangle k. Let's see how the area of the rectangle changes when we add liquidity.
00:13:45.278 - 00:14:12.522, Speaker A: When we add liquidity, we are increasing this area of the rectangle. X was over here and it moves over to the right to x plus dx. Y was over here and it increases to y plus dy. X plus dx times y plus dy will be this big pink rectangle. By adding liquidity, we increase the area of the rectangle from k to k. Prime. Adding liquidity increases k, the area of the rectangle x times y.
00:14:12.522 - 00:14:52.714, Speaker A: So how about we define f of x and y, a function that measures total liquidity of token a and token b to be x times y. Well, this is not a good idea. This is because if we define the function f of x of y to equal x times y, then x times y is quadratic, which is not good. Let me show you an example. Let's say that we have liquidity of one token a and one token b, then f of eleven is equal to one. If we add ten of token a and ten of token b, then f of 1010 is 100. If we add 100 of both tokens, then f of 100, 100 is 10,000 and if we add 1000 of each of the tokens, then total liquidity will be 1 million.
00:14:52.714 - 00:15:51.498, Speaker A: Notice that when we define total liquidity to be x times y, then total liquidity increases much quicker than the actual amount of tokens inside the amm. So from this example, what we want to say is that f of x and y should be like linear if I add ten tokens each, then total liquidity should be close to something like ten. And if we add 100 tokens, then total liquidity should be something close to 100. And if we add 1000 tokens each, then total liquidity should be close something to 1000. So let's say that we want to restrict the function f of x of Y to be some constant multiplied by the maximum of tokens x and y. In other words, total liquidity should be no greater than the amount of tokens locked in the amm multiplied by some constant. So how about f of x of Y is equal to the square root of x times y? If we define total liquidity to equal the square root of x times y, then when we add liquidity, it still tracks the increase in k.
00:15:51.498 - 00:16:26.050, Speaker A: And also, total liquidity does not grow much quicker than the actual amount of tokens inside the amm. F of xy is like linear. The square root of x times y is no greater than two times the max of x and y. So now we defined f of x or Y is a function that measures total liquidity of constant product amm. And we defined it to be equal to the square root of x times y. Now I want to answer to a question. What is l zero and l one? L zero is total liquidity before adding liquidity, and l one is total liquidity after adding liquidity.
00:16:26.050 - 00:17:01.838, Speaker A: And the other part of this video is. I want to simplify this equation. L1 minus l zero over l zero multiplied by t is equal to the amount of shares to mint. Let's start with the easy question. What is l zero and l one? Well, by definition, f of x of Y is total liquidity and total liquidity before adding liquidity is square root of x times y. So l zero is equal to square root of x times y. How about after adding liquidity, what is l one? Well, after adding liquidity, the new x and Y are x plus dx and Y plus dy.
00:17:01.838 - 00:17:32.298, Speaker A: Plug the new x and Y into this function. F of x y equal to square root of x times y. And we get that l one is equal to the square root of x plus dx multiplied by y plus dy. Now that we know what l zero and l one are, we can now simplify this equation. L1 minus l zero over l zero. For the rest of the video, we'll simplify this equation using algebra. And it turns out that this expression is equal to dx over x, which is equal to dy over y.
00:17:32.298 - 00:18:18.886, Speaker A: So let's see why that is the case. From the left side of the equation, we'll replace l one and l zero with what we found over here. And it turns out that this equation is equal to the square root of x plus dx multiplied by y plus dy minus the square root of x times y all over the square root of x times y. Okay, let's expand this part of the equation and we get that this expression is equal to x times y plus x times dy plus dx times y plus dx times dy, and the rest of the equation are the same. Next, let's replace dy. Earlier we said that dx over dy is equal to x over y. So we can solve for dy from this equation.
00:18:18.886 - 00:18:45.330, Speaker A: Dx over dy is equal to x over Y. And we get that dy is equal to Y times dx over x. And we'll replace dy in this equation. Replacing dy with y times dx over x. Replace the dy over here and over here with this equation, and we get this equation, the rest of the equation are the same. Next, we can simplify this equation. Notice that the x over here and the x over here cancels out.
00:18:45.330 - 00:19:29.538, Speaker A: And over here we have two dx's. So the equation turns out to be X times Y plus Y times dx. The x is cancelled out plus dx times Y plus dx square that you see over here from dx, and another dx times y over x. And notice that we have x in all of the terms. So let's pull this y out, pull the y out from this part of the equation, and we get inside the square root x plus two times dx plus dx squared over x multiplied by y. The next thing that I want to do is remove this x from the term dx squared over x. So we'll multiply this term by square root of x over square root of x.
00:19:29.538 - 00:20:01.146, Speaker A: Basically, we're multiplying by one. When we multiply by the square root of x, we're basically putting x inside this expression. So we get x squared plus two X times dx plus dx squared times y. Multiply the next term by the square root of x, and inside we get x squared times y and the same for the denominator. Notice that from over here, we can pull out the x squared to outside of the square root. Likewise, we can do the same over here. And also notice this term, x squared plus two x times dx plus dx square.
00:20:01.146 - 00:20:44.874, Speaker A: This is equal to x plus dx square. So we can pull out the term x plus dx from this square root, and we get the equation x plus dx multiplied by the square root of y minus x times the square root of y over x times the square root of Y. Okay, we'll expand this equation, and we get the equation on the right. Notice that we have x times square root of y minus x times square root of y. Those two terms cancel out. And now we're left with dx over square root of the y over x over square root of y. So we can cancel out the square root of y's and we're left with dx over x.
00:20:44.874 - 00:21:43.006, Speaker A: So this equation is equal to dx over x. And what did we solve? Well, we solved that l one minus l zero over l zero is equal to dx over x, which you can see over here. Using a similar argument over here, you can solve that l one minus l zero over l zero is equal to dy over y. And we now have all of the equation to come to the conclusion that when we add liquidity, the amount of shares to men is equal to this equation over here. Earlier, we set that amount of shares to men is equal to l one minus l zero over l zero times total shares. We also found out above that l one minus l zero over l zero is equal to dx over x, which is equal to dy over y. So, putting these two equations together, we can conclude that s is equal to dx over x times t, which is equal to dy over y times t.
00:21:43.006 - 00:22:33.034, Speaker A: Starting from this equation, we're replacing this term with this equation that we just found. To arrive at this equation. The amount of shares to mint is the ratio of the amount of token a to add over the balance of token a times the total shares, which is also equal to the amount of token b to add divided by the amount of token b inside the amm times total shares. When you remove liquidity from a constant product amm, how many tokens should you receive? The answer is dx. The amount of token a that you'll receive is equal to x times s over t. X is the amount of token a inside amm, s is the amount of shares to burn, and t is the total shares, and dy, the amount of token b that you'll receive is equal to y times s divided by t. Y is the amount of token b inside the amm.
00:22:33.034 - 00:23:13.942, Speaker A: Let's see why this is like the math for withdrawing from a vault and removing liquidity from a constant sum amm. We want to withdraw tokens proportional to the shares that we're going to be burning. Let's write this constraint as a math equation. Let's say that a is equal to the total amount of tokens that we can withdraw, and this is a single number measured by the equation square root of dx times dy. Dx being the amount of token a that we can withdraw, and dy is the amount of token b that we can withdraw. We'll define ls total liquidity and this is equal to the square root of x times y, the amount of token a and amount of token b inside the amm. S is the amount of shares to burn, and t is the total shares.
00:23:13.942 - 00:24:09.526, Speaker A: Withdrawal tokens proportional to shares means that a over l is equal to s over t. The amount of liquidity that we can withdraw over the total liquidity is equal to the amount of shares over total shares. To find out how many tokens to withdraw, we need to solve for a and we get that a is equal to l times s over t. Now let's replace a with the square root of dx times dy and l with the square root of x times y and we get this equation. This equation tells us that the amount of liquidity that we can withdraw must satisfy this equation. But can we do better and find the equation for dx in terms of x, y and s and t? Well, from this equation we can replace dy since we know that dx over dy is equal to x over y. This was derived when we worked out the math for swaps so we can solve for dy.
00:24:09.526 - 00:24:46.050, Speaker A: Dy is equal to y times dx over x and then we'll replace this dy with this equation over here. Replace this dy and we get this expression over here. Notice that we have two dx's, dx over here and dx over here. That is dx square. So we can pull out dx square from inside the square root to outside, pull out the dx. And notice that we can now solve for dx just by dividing both side of the equation by the square root of y over x. Divide both side of this equation by the square root of y over x and we get this equation.
00:24:46.050 - 00:25:11.326, Speaker A: Let's simplify this equation. Notice that from this equation we have a square root of y at the bottom as a denominator. And we also have a square root of y. So we can cancel those two out. And we're left with square root of x times the square root of x. Square root of x times the square root of x is equal to x. So these two square root of x simplifies to x.
00:25:11.326 - 00:25:38.900, Speaker A: We cancel out the square root of y's. So we're left with s over t times x. And we have found out what dx is equal to dx is equal to x times s over t. Likewise, we can solve for dy to get that dy is equal to y times s over t. And that concludes the math for removing liquidity. When we remove liquidity, how many tokens to withdraw? The answer is this equation over here.
